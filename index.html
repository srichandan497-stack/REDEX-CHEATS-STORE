<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Prime x cheats storel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg: #ffffff; /* force white background */
            --text: #ffffff;
            --card: rgba(11,18,32,0.03);
            --glass-border: rgba(11,18,32,0.06);
            --primary: #ffffff;
            --star: #c27800;
            --bg-animation-duration: 1s; /* animation time (can be changed via slider) */
            --skeleton-start: #f3f4f6;
            --skeleton-end: #ffffff;
        }

        /* light / white mode only (dark mode removed) */
        .black-mode {
            --bg: #ffffff; /* force white background */
            --text: #0b1220;
            --card: rgba(11,18,32,0.03);
            --glass-border: rgba(11,18,32,0.06);
            --primary: #2563eb;
            --star: #c27800;
        }

        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Inter', sans-serif; transition: 0.3s; }
        body { background: var(--bg); color: var(--text); padding-bottom: 120px; overflow-x: hidden; position: relative; transition: background 0.45s ease, color 0.45s ease; }

        /* Scrollbar: white thumb as requested (#ffffff) */
        /* WebKit */
        *::-webkit-scrollbar { width: 10px; height: 10px; }
        *::-webkit-scrollbar-track { background: transparent; }
        *::-webkit-scrollbar-thumb { background: #ffffff; border-radius: 999px; border: 2px solid rgba(0,0,0,0.04); }
        *::-webkit-scrollbar-corner { background: transparent; }
        /* Firefox */
        html { scrollbar-color: #ffffff transparent; scrollbar-width: thin; }

        body::before {
            content: "";
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 20% 30%, rgba(99, 102, 241, 0.02) 0%, transparent 40%),
                        radial-gradient(circle at 80% 70%, rgba(244, 114, 182, 0.02) 0%, transparent 40%);
            z-index: -1;
            animation: bgMove var(--bg-animation-duration) infinite alternate ease-in-out;
        }
        @keyframes bgMove { 0% { transform: scale(1) translate(0, 0); } 100% { transform: scale(1.02) translate(8px, 8px); } }

        /* Header: changed background color to a soft gradient */
        /* NOTE: glassy backdrop-filter removed as requested (no 'glass animation') and colors replaced with teal/green gradient */
        /* UPDATED: top app bar forced to white as requested */
        header { padding: 12px 15px; position: sticky; top: 0; z-index: 1000; background: #ffffff; color: #0b1220; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #ffffff; }
        .brand { font-size: 20px; font-weight: 900; color: #0b1220; background: none; -webkit-background-clip: unset; -webkit-text-fill-color: unset; }

        .left-header { display:flex; align-items:center; gap:12px; }
        .search-container { background: var(--card); border-radius: 20px; display: flex; align-items: center; padding: 5px 15px; width: 65%; height: 38px; border: 1px solid var(--glass-border); }
        .search-container input { border: none; background: transparent; width: 100%; outline: none; color: var(--text); font-size: 14px; margin-left: 8px; }
        /* ensure search text is readable on white header */
        header .search-container { background: rgba(11,18,32,0.03); }
        header .search-container input { color: #0b1220; }
        header .search-container i { color: #64748b; opacity: 0.9; }

        .theme-controls { display:flex; align-items:center; gap:8px; }
        .moon-btn, .sun-btn { font-size:22px; cursor:pointer; padding:4px; border-radius:8px; color: inherit; }
        .moon-btn.active, .sun-btn.active { color:var(--primary); text-shadow:0 0 12px rgba(99,102,241,0.3); }

        /* profile button */
        .profile-btn { display:flex; align-items:center; gap:8px; cursor:pointer; padding:6px; border-radius:12px; border:1px solid transparent; transition:0.15s; }
        .profile-btn:hover { border-color: rgba(11,18,32,0.06); }
        .profile-avatar { width:40px; height:40px; border-radius:50%; object-fit:cover; border:1px solid rgba(11,18,32,0.06); background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); }
        .profile-name { font-size:13px; font-weight:700; color:var(--text); }

        .section { margin-top: 25px; padding: 0 15px; }
        .sec-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .sec-title { font-size: 18px; font-weight: 800; border-left: 4px solid var(--primary); padding-left: 10px; }
        .see-more { color: var(--primary); font-size: 13px; font-weight: 700; cursor: pointer; }

        .top-banner-row { display: flex; gap: 12px; overflow-x: auto; scrollbar-width: none; padding-bottom: 10px; }
        .top-banner-card { min-width: 280px; height: 160px; border-radius: 20px; background: var(--card); border: 1px solid var(--glass-border); overflow: hidden; position: relative; flex-shrink: 0; cursor: pointer; }
        .top-banner-card img { width: 100%; height: 100%; object-fit: cover; }
        .banner-info { position: absolute; bottom: 0; left: 0; right: 0; padding: 10px; background: linear-gradient(transparent, rgba(0,0,0,0.08)); color: var(--text); font-size: 14px; font-weight: bold; }

        .app-row { display: flex; gap: 15px; overflow-x: auto; scrollbar-width: none; padding-bottom: 10px; }
        .app-card { min-width: 105px; max-width: 105px; text-align: center; cursor: pointer; display: flex; flex-direction: column; align-items: center; background: var(--card); padding: 10px; border-radius: 22px; border: 1px solid var(--glass-border); position: relative; }
        .icon-box { width: 85px; height: 85px; border-radius: 18px; overflow: hidden; margin-bottom: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.02); display:flex; align-items:center; justify-content:center; background: rgba(0,0,0,0.02); position:relative; }
        .icon-box img { width:100%; height:100%; object-fit:cover; display:block; transition: opacity 0.18s ease; opacity: 1; }

        /* while icon is loading/hidden show neutral pulsing animation */
        .icon-box.loading {
            filter: none;
            background: linear-gradient(90deg, #f3f4f6, #ffffff);
            border-color: rgba(11,18,32,0.03) !important;
            animation: lightPulse 1.6s infinite ease-in-out;
        }
        .icon-box.loading img { opacity: 0; }

        .app-name { font-size: 12px; font-weight: 600; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 6px; color: var(--text); }

        /* small inline stats under each app icon */
        .app-stats { display:flex; gap:8px; align-items:center; font-size:11px; color: #6b7280; }
        .app-stats .stat { display:flex; gap:6px; align-items:center; padding:4px 6px; border-radius:12px; background: rgba(0,0,0,0.03); border: 1px solid var(--glass-border); }
        .app-stats .stat i { color: var(--primary); font-size:12px; }
        .app-stats .stat .num { font-weight:700; color:var(--text); font-size:12px; }

        @keyframes lightPulse {
            0% { transform: scale(1); opacity: 0.9; }
            50% { transform: scale(1.01); opacity: 1; }
            100% { transform: scale(1); opacity: 0.9; }
        }

        /* Updated bottom-nav to match the provided screenshot: full-width, darker, subtle top border, centered items and active highlight */
        /* NOTE: removed backdrop-filter to remove glassy blur and changed gradient colors to match header (teal/green) */
        /* UPDATED: bottom navigation forced to white as requested */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: calc(64px + env(safe-area-inset-bottom));
            padding: 10px 12px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            background: #ffffff;
            border-top: 1px solid rgba(11,18,32,0.06);
            display:flex;
            justify-content: space-around;
            align-items: flex-end;
            z-index: 2000;
            box-shadow: none; /* remove floating card shadow for flat bar look */
        }
        .nav-item {
            text-align:center;
            color: #475569; /* darker gray for visibility on white */
            font-size: 13px;
            cursor:pointer;
            flex: 1;
            display:flex;
            flex-direction: column;
            align-items:center;
            justify-content: center;
            gap:6px;
            min-width: 64px;
            max-width: 110px;
            padding: 6px 8px;
            transition: transform 0.12s ease, color 0.15s ease;
            -webkit-tap-highlight-color: transparent;
            padding-top: 8px; /* push icons/text slightly down */
            padding-bottom: 6px;
            -webkit-user-select: none;
            user-select: none;
        }
        /* move icons and label slightly down to appear lower */
        .nav-item i, .nav-item .nav-label {
            transform: translateY(4px);
            transition: transform 0.12s ease, color 0.15s ease;
        }
        .nav-item i {
            display:block;
            font-size: 22px;
            line-height: 1;
            width: 36px;
            height: 36px;
            display:flex;
            align-items:center;
            justify-content:center;
            border-radius:10px;
            color: inherit;
        }
        .nav-item .nav-label {
            font-size: 13px;
            margin-top: 2px;
            color: inherit;
        }
        .nav-item.active {
            color: var(--primary);
            font-weight: 800;
        }
        /* Active icon: filled rounded background and brighter icon color - keep active slightly raised relative to others */
        .nav-item.active i {
            background: rgba(99,102,241,0.08);
            color: var(--primary);
            transform: translateY(2px); /* active slightly up compared to idle */
            box-shadow: 0 6px 18px rgba(99,102,241,0.04);
        }
        /* make inactive icons slightly muted but interactive on tap */
        .nav-item:active { transform: translateY(1px); }

        .modal, .modal-full { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:5000; align-items:center; justify-content:center; }
        .modal-full { background: var(--bg); overflow-y:auto; padding:20px; z-index:6000; flex-direction:column; }

        /* NEW: modal content wrapper so dropdowns render above overlay */
        .modal .modal-content {
            width:100%;
            max-width:820px;
            background:var(--bg);
            border-radius:12px;
            padding:18px;
            border:1px solid var(--glass-border);
            position: relative; /* create stacking context for inner content */
            z-index: 6001;     /* higher than parent's z-index to ensure selects render correctly */
            overflow: visible; /* allow custom dropdown to overflow */
        }

        /* When upload modal is full-screen make modal-content fill and scroll */
        .modal-full .modal-content {
            width:100%;
            max-width: 1100px;
            height: calc(100vh - 60px);
            max-height: calc(100vh - 60px);
            border-radius: 12px;
            padding: 18px;
            overflow-y: auto;
            box-shadow: 0 10px 50px rgba(0,0,0,0.06);
            border: 1px solid var(--glass-border);
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
        }

        input, select, textarea { width:100%; padding:12px; margin:8px 0; border-radius:15px; border:1px solid var(--glass-border); background: rgba(255,255,255,0.95); color:var(--text); outline:none; }

        /* Ensure select dropdown appears above overlay and other stacking contexts */
        .modal select, .modal input, .modal textarea, .modal .img-preview {
            position: relative;
            z-index: 6002;
        }

        /* On some browsers, appearance affects dropdown; ensure native appearance */
        .modal select { -webkit-appearance: menulist-button; appearance: auto; }

        .btn-download { width:100%; padding:15px; background: linear-gradient(to right, var(--primary), #a855f7); color:#fff; border:none; border-radius:15px; font-weight:bold; font-size:16px; margin:20px 0; box-shadow:0 4px 15px rgba(99,102,241,0.12); }

        .comment-section { margin-top:30px; padding-top:20px; border-top:1px solid var(--glass-border); }
        .comment-item { background: var(--card); padding:12px; border-radius:15px; margin-bottom:10px; border:1px solid var(--glass-border); }
        .comment-user { font-weight:bold; color:var(--primary); font-size:13px; margin-bottom:4px; }
        .comment-text { font-size:14px; opacity:0.95; margin-bottom:6px; color:var(--text); }
        .comment-date { font-size:12px; color:#9aa3c7; }

        /* new avatar inside comments */
        .comment-row { display:flex; gap:10px; align-items:flex-start; }
        .comment-avatar { width:40px; height:40px; border-radius:50%; object-fit:cover; border:1px solid var(--glass-border); flex-shrink:0; }
        .comment-body { flex:1; }

        .stat-box { display:flex; justify-content:space-around; padding:15px 0; border-top:1px solid var(--glass-border); border-bottom:1px solid var(--glass-border); text-align:center; margin:10px 0; }

        .zoom-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:10000; align-items:center; justify-content:center; }
        .zoom-overlay img { max-width:95%; max-height:80%; border-radius:10px; box-shadow:0 0 20px rgba(255,255,255,0.2); }
        .close-zoom { position:absolute; top:30px; left:20px; color:white; font-size:24px; cursor:pointer; }

        .ss-img { height:220px; border-radius:10px; cursor:pointer; transition: transform 0.2s; }
        .ss-img:active { transform: scale(0.95); }

        /* Loading shimmer for screenshots while they load */
        .ss-img.loading {
            background: linear-gradient(90deg, var(--skeleton-start), var(--skeleton-end));
            background-size: 200% 100%;
            animation: shimmer 1.2s infinite linear;
            display:block;
            color: transparent;
            /* ensure visible min height while loading */
            min-height: 220px;
            object-fit: cover;
        }

        .share-btn { padding:10px 12px; border-radius:12px; border:none; cursor:pointer; font-weight:700; display:inline-flex; gap:8px; align-items:center; justify-content:center; }
        .share-primary { background: linear-gradient(to right, #06b6d4, #3b82f6); color: #fff; }

        /* styling for links inside description */
        .desc a { color: var(--primary); text-decoration: underline; cursor: pointer; }

        /* News specific - increased thumbnail size and responsive layout */
        .news-card { display:flex; gap:12px; background:var(--card); padding:12px; border-radius:12px; border:1px solid var(--glass-border); align-items:center; cursor:pointer; transition: 0.2s; flex-direction:column; width:100%; }
        .news-card:hover { transform: translateY(-4px); }
        /* Make news rows stacked line-by-line (thumbnail on top, meta below) */
        .news-row { display:flex; gap:12px; width:100%; align-items:flex-start; flex-direction:column; }
        /* Adjusted: allow news thumbnail to size to its content (wrap_content-like behavior) */
        .news-thumb { width: auto; max-width:100%; height: auto; border-radius:8px; overflow:hidden; flex-shrink:0; }
        .news-thumb img { width: auto; max-width: 100%; height: auto; object-fit: contain; display:block; }
        .news-meta { flex:1; display:flex; flex-direction:column; gap:8px; }
        .news-title { font-weight:800; font-size:18px; color:var(--text); margin-bottom:6px; }
        .news-desc { font-size:14px; color:gray; max-height:80px; overflow:hidden; text-overflow:ellipsis; }
        .open-news-link { display:inline-block; margin-top:8px; padding:8px 12px; background: linear-gradient(to right, #06b6d4, #3b82f6); color:#fff; border-radius:10px; text-decoration:none; font-weight:700; }
        .open-news-link:active { transform: translateY(1px); }

        /* Make links inside news lists/detail blue and clickable */
        .news-meta a, .news-desc a, .news-detail a { color: var(--primary); text-decoration: underline; }

        /* large news detail inline */
        .news-detail { display:flex; flex-direction:column; gap:12px; }
        .news-detail .hero { width:100%; border-radius:12px; overflow:hidden; }
        .news-detail .hero img { width:100%; height:auto; display:block; object-fit:cover; }
        .news-detail .back-btn { color:var(--primary); font-weight:700; cursor:pointer; margin-bottom:6px; }

        @media (max-width: 700px) {
            .search-container { width: 55%; }
            #searchResults { grid-template-columns: repeat(2, 1fr) !important; }
            .news-card { flex-direction: column; align-items: flex-start; }
            .news-thumb { width:100%; height:auto; }
            .news-title { font-size:16px; }

            /* make upload modal content full width on small screens */
            .modal-full .modal-content {
                max-width: 96%;
                height: calc(100vh - 40px);
                max-height: calc(100vh - 40px);
                padding: 12px;
            }

            /* tweak bottom nav spacing for small screens */
            .bottom-nav {
                height: calc(70px + env(safe-area-inset-bottom));
                padding-top: 8px;
            }
        }

        /* like button active style */
        .like-active { background: linear-gradient(to right, #ff6b6b, #ffb86b); color: #fff; border-radius:12px; padding:10px 12px; display:inline-flex; gap:8px; align-items:center; cursor:pointer; font-weight:700; border:none; }
        .img-preview { width: 100px; height: 70px; object-fit: cover; border-radius:8px; border:1px solid var(--glass-border); display:block; margin-top:6px; }

        /* small/large preview variants (user toggle) */
        .img-preview.small { width: 60px; height: 42px; }
        .img-preview.large { width: 200px; height: 140px; }

        /* upload time small text in modal */
        .upload-time-small { color:gray; font-size:13px; margin-top:6px; }

        /* Custom select styles (mobile-friendly, avoids native select popup issues) */
        .custom-select {
          background: rgba(255,255,255,0.95);
          border: 1px solid var(--glass-border);
          border-radius: 15px;
          padding: 10px 12px;
          color: var(--text);
          cursor: pointer;
          position: relative;
          user-select: none;
          display: inline-block;
          width: 100%;
        }
        .custom-select .selected {
          font-weight: 700;
          display:flex;
          justify-content:space-between;
          align-items:center;
          gap:8px;
        }
        .custom-select .selected::after {
          content: "â–¾";
          opacity: 0.8;
          font-size: 14px;
        }
        .custom-select .options {
          position: absolute;
          left: 0;
          right: 0;
          top: calc(100% + 8px);
          background: var(--bg);
          border-radius: 12px;
          border: 1px solid var(--glass-border);
          box-shadow: 0 10px 30px rgba(0,0,0,0.05);
          z-index: 100000 !important; /* make sure it's on top */
          max-height: 260px;
          overflow-y: auto;
          display: none;
          padding: 6px;
        }
        .custom-select.open .options { display: block; }
        .custom-select .option {
          padding: 10px 12px;
          border-radius: 10px;
          cursor: pointer;
          color: var(--text);
        }
        .custom-select .option:hover, .custom-select .option.active {
          background: rgba(99,102,241,0.12);
          color: var(--primary);
        }

        /* News action row style (to resemble image) */
        .news-actions { display:flex; gap:14px; align-items:center; margin-top:8px; }
        .news-actions .icon { font-size:22px; color: #111827; cursor:pointer; }
        .news-likes-count { margin-top:8px; font-weight:800; font-size:18px; color: #111827; }
        .news-comments-placeholder { color: #6b7280; margin-top:8px; font-size:15px; }
        .news-comment-input-row { display:flex; gap:12px; margin-top:12px; align-items:center; }
        .news-comment-input { flex:1; padding:12px 16px; border-radius:25px; border:1px solid var(--glass-border); background: rgba(255,255,255,0.95); color:var(--text); }
        .news-post-btn { background: transparent; color: var(--primary); border: none; font-weight:800; cursor:pointer; padding:8px 12px; }

        /* New: show-more comments button */
        .show-more-comments { margin-top:8px; color:var(--primary); cursor:pointer; font-weight:800; background: transparent; border: none; padding:8px 10px; border-radius:8px; text-align:left; }
        .all-comments { margin-top:8px; display:none; }
        .all-comments.open { display:block; }

        /* Profile modal settings layout */
        .profile-settings-card { margin-top:12px; background:var(--card); padding:16px; border-radius:12px; border:1px solid var(--glass-border); }
        .setting-row { display:flex; justify-content:space-between; align-items:center; gap:12px; padding:8px 0; }
        .setting-label { font-weight:700; font-size:15px; }
        .setting-sub { color:gray; font-size:13px; margin-top:4px; }
        .toggle-switch { width:46px; height:26px; border-radius:30px; background: rgba(255,255,255,0.06); position:relative; cursor:pointer; }
        .toggle-switch .knob { width:20px; height:20px; border-radius:50%; background:#fff; position:absolute; top:3px; left:3px; transition: 0.2s; }
        .toggle-switch.on { background: linear-gradient(90deg,#6366f1,#06b6d4); }
        .toggle-switch.on .knob { left: 23px; }

        /* OFFLINE: show neutral pulsing animation on icons when offline */
        .offline .icon-box,
        .offline .icon-box img,
        .offline .ss-img,
        .offline .profile-avatar,
        .offline .nav-item img,
        .offline .nav-item i,
        .offline .news-thumb img {
            filter: grayscale(30%) contrast(0.9);
            background: linear-gradient(90deg, #f3f4f6, #ffffff);
            border-color: rgba(11,18,32,0.03) !important;
            animation: lightPulse 1.6s infinite ease-in-out;
            opacity: 0.95;
        }

        /* offline status indicator (small) */
        #offlineIndicator { position: fixed; right:14px; top:70px; padding:8px 10px; background:#111; color:#fff; border-radius:12px; border:1px solid rgba(255,255,255,0.04); font-size:13px; z-index:9999; display:none; }
        body.offline #offlineIndicator { display:block; }

        /* profile modal tweaks to look better - instagram like */
        .profile-header { display:flex; gap:12px; align-items:center; }
        .profile-ring { display:inline-flex; padding:4px; border-radius:999px; background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); }
        .profile-preview-lg { width:72px; height:72px; border-radius:50%; object-fit:cover; border:3px solid rgba(255,255,255,0.06); display:block; }
        .profile-meta { display:flex; flex-direction:column; gap:6px; }
        .profile-meta h3 { margin:0; font-size:18px; }
        .profile-meta .sub { color:gray; font-size:13px; }
        .profile-actions { display:flex; gap:10px; margin-top:8px; }

        .remove-photo-btn { background: transparent; color: #ef4444; border: 1px solid rgba(239,68,68,0.12); padding:6px 10px; border-radius:10px; cursor:pointer; font-weight:700; }

        /* ---------- World Chat Styles ---------- */
        /* NOTE: world chat UI removed from DOM; CSS retained harmlessly */
        /* ---------- Skeleton / Loading placeholders ---------- */
        .skeleton {
            background: linear-gradient(90deg, var(--skeleton-start), var(--skeleton-end));
            background-size: 200% 100%;
            animation: shimmer 1.2s infinite linear;
            border-radius: 10px;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* small skeleton variants */
        .skeleton-icon { width: 85px; height:85px; border-radius:18px; }
        .skeleton-card { width: 105px; padding: 10px; display:flex; flex-direction:column; gap:8px; align-items:center; }
        .skeleton-name { width:70px; height:12px; border-radius:8px; }
        .skeleton-top { width:280px; height:160px; border-radius:20px; }
        .skeleton-news { width:100%; height:180px; border-radius:12px; }
        .skeleton-line { width:100%; height:12px; border-radius:8px; margin-top:6px; }
        .skeleton-small-line { width:60%; height:10px; border-radius:8px; margin-top:6px; }

        /* smaller world chat skeleton lines */
        .wc-skel-line { width:75%; height:12px; border-radius:8px; margin-bottom:8px; }
        .wc-skel-photo { width:180px; height:110px; border-radius:8px; margin-bottom:8px; }

        /* ---------------- Search results "Play Store" style ---------------- */
        /* container override for list mode */
        #searchResults {
            display: block;
            width: 100%;
            max-width: 920px;
            margin: 0 auto;
        }
        .search-item {
            display: flex;
            gap: 14px;
            padding: 14px;
            border-radius: 12px;
            align-items: center;
            cursor: pointer;
            border: 1px solid transparent;
            transition: background 0.15s ease, border-color 0.12s ease, transform 0.08s ease;
            background: transparent;
            margin-bottom: 6px;
        }
        .search-item:hover {
            background: rgba(11,18,32,0.02);
            border-color: var(--glass-border);
            transform: translateY(-1px);
        }
        .result-icon {
            width: 72px;
            height: 72px;
            flex-shrink: 0;
            border-radius: 16px;
            overflow: hidden;
            background: linear-gradient(90deg, #f3f4f6, #ffffff);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--glass-border);
        }
        .result-icon img {
            width: 64px;
            height: 64px;
            object-fit: cover;
            border-radius: 12px;
            display:block;
        }
        .result-meta {
            flex: 1;
            min-width: 0;
        }
        .result-title {
            font-weight: 800;
            font-size: 16px;
            color: var(--text);
            margin-bottom: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .result-sub {
            color: #6b7280;
            font-size: 13px;
            margin-bottom: 8px;
            display:flex;
            gap:8px;
            flex-wrap: wrap;
            align-items: center;
        }
        .pill {
            display:inline-flex;
            gap:6px;
            align-items:center;
            padding:6px 8px;
            border-radius: 999px;
            background: rgba(99,102,241,0.06);
            color: var(--primary);
            font-weight:700;
            font-size:13px;
            border: 1px solid rgba(99,102,241,0.06);
        }
        .meta-small {
            display:flex;
            gap:10px;
            color:#6b7280;
            font-size:13px;
            align-items:center;
            flex-wrap:wrap;
        }
        .chev-btn {
            width: 44px;
            height: 44px;
            border-radius: 999px;
            background: rgba(11,18,32,0.04);
            display:flex;
            align-items:center;
            justify-content:center;
            color: #475569;
            flex-shrink: 0;
            transition: transform 0.18s ease, background 0.15s;
        }
        .chev-btn i { transform: translateY(1px); transition: transform 0.18s ease; }

        /* open state: rotate icon and slightly change background */
        .chev-btn.open { background: rgba(99,102,241,0.08); color: var(--primary); }
        .chev-btn.open i { transform: rotate(180deg) translateY(1px); }

        /* expanded area inserted below list item */
        .search-expand {
            max-width: 920px;
            margin: 0 auto 10px;
            padding: 12px 14px;
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            background: #ffffff;
            box-shadow: 0 6px 18px rgba(16,24,40,0.04);
            color: var(--text);
            font-size: 14px;
        }
        .search-expand .ss-row {
            display:flex;
            gap:8px;
            overflow-x:auto;
            padding-bottom:8px;
            margin-bottom:8px;
        }
        .search-expand .ss-row img {
            height: 140px;
            width: auto;
            border-radius: 12px;
            object-fit: cover;
            cursor: pointer;
            border: 1px solid var(--glass-border);
        }
        .search-expand .about {
            color: #374151;
            line-height: 1.45;
            margin-bottom:8px;
        }

        /* small tweaks for mobile */
        @media (max-width:600px) {
            .result-title { font-size: 15px; }
            .result-sub { font-size: 12px; }
            .pill { font-size: 12px; padding:5px 7px; }
            .result-icon { width:60px; height:60px; }
            .result-icon img { width:52px; height:52px; }
            .search-expand .ss-row img { height: 110px; }
        }

        /* =================== USER REQUEST OVERRIDES ===================
           1) Remove touch ripple / tap highlight
           2) Prevent bottom nav/button from moving up on tap/click
           3) Keep other styles intact by using !important only where necessary
           ============================================================ */

        /* Disable tap highlight / ripple across interactive elements */
        html, body, button, a, input, textarea, select, .nav-item, .chev-btn, .search-item, .app-card, .share-btn {
            -webkit-tap-highlight-color: transparent !important;
            tap-highlight-color: transparent !important;
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
        }

        /* Ensure no visual "upward" translation on click for bottom nav items */
        .nav-item:active { transform: none !important; }
        .nav-item i, .nav-item .nav-label { transform: none !important; }
        /* Prevent active-state micro movement for icons */
        .nav-item.active i { transform: none !important; box-shadow: 0 6px 18px rgba(99,102,241,0.04); }

        /* Prevent chevron/button click from shifting */
        .chev-btn:active, .search-item:active, .app-card:active, .share-btn:active {
            transform: none !important;
        }

        /* Keep hover/active visual cues but without movement (use background and color only) */
        .nav-item.active { color: var(--primary) !important; }
        .nav-item.active i { background: rgba(99,102,241,0.08) !important; color: var(--primary) !important; }

        /* Accessibility: show focus outlines but no movement */
        .nav-item:focus, .chev-btn:focus, .search-item:focus, .share-btn:focus {
            outline: 2px solid rgba(37,99,235,0.12);
            outline-offset: 2px;
            transform: none !important;
        }

        /* Small tweak: avoid hover translate on search items for touch devices */
        @media (hover: none) {
            .search-item:hover { transform: none; }
        }

        /* ========== ADDITIONS FOR USER REQUESTS ========== */

        /* 1) Move bottom-nav icons slightly lower (medium niche) while respecting prior no-movement rules.
           We add stronger rules with !important to ensure desired visual placement. */
        .bottom-nav .nav-item i,
        .bottom-nav .nav-item .nav-label {
            transform: translateY(10px) !important;
        }
        /* Keep active slightly raised relative to idle but still lower than original baseline */
        .bottom-nav .nav-item.active i,
        .bottom-nav .nav-item.active .nav-label {
            transform: translateY(6px) !important;
        }

        /* 2) Profile modal: hide Links section and Profile Link container (do not remove code - hide via CSS/JS as well) */
        /* We'll hide any explicit links and the profile link container inside the modal.
           We'll also provide a fail-safe selector to hide typical patterns. */
        #profileModal .links-hidden, /* in case we mark via JS later */ 
        #profileModal .profile-links-block,
        #profileModal .profile-link-block {
            display: none !important;
        }

        /* End additions */
    </style>
</head>
<body onload="initApp()">
<header>
    <div class="left-header">
        <div class="brand">prime x cheats store</div>
        <!-- Header search container: hidden by default and shown only when Search nav is active -->
        <div id="headerSearchContainer" class="search-container" style="display:none;">
            <i class="fa-solid fa-magnifying-glass" style="opacity: 0.5;"></i>
            <input type="text" id="searchInput" placeholder="Search..." oninput="doSearch()">
        </div>
    </div>

    <div style="display:flex; align-items:center; gap:10px;">
        <!-- Theme toggle(dark mode no longer supported) -->

        <!-- Header profile quick button (shows current avatar only) -->
        <div id="profileBtnHeader" class="profile-btn" onclick="openProfileModal()" title="Open profile">
            <img id="headerAvatar" class="profile-avatar" src="https://via.placeholder.com/40" alt="avatar" onerror="onProfileAvatarError(this)" loading="lazy">
            <!-- name removed from header as requested -->
        </div>
    </div>
</header>

<div id="offlineIndicator">You are offline</div>

<div id="search-view" style="display:none; padding: 20px;">
    <h2 style="margin-bottom:15px;">Search Results</h2>
    <div id="searchResults"></div>
</div>

<div id="news-view" style="display:none; padding: 20px;">
    <h2 style="margin-bottom:15px;">All post</h2>
    <div id="newsList" style="display:grid; grid-template-columns: repeat(1, 1fr); gap: 12px;"></div>
</div>

<div id="home-view">
    <div id="main-content-home">
        <div class="section">
            <div class="sec-header"><div class="sec-title">Top Project</div></div>
            <div id="grid-top" class="top-banner-row"></div>
        </div>

        <!-- NEW main "New" section -->
        <div class="section">
            <div class="sec-header"><div class="sec-title"> New</div><div class="see-more" onclick="goToAll()">See more</div></div>
            <div id="grid-new-main" class="app-row"></div>
        </div>

        <div class="section">
            <div class="sec-header"><div class="sec-title">Trending</div><div class="see-more" onclick="goToAll()">See more</div></div>
            <div id="grid-trending" class="app-row"></div>
        </div>
        <div class="section">
            <div class="sec-header"><div class="sec-title">New & Updated</div><div class="see-more" onclick="goToAll()">See more</div></div>
            <div id="grid-new" class="app-row"></div>
        </div>
        <div class="section">
            <div class="sec-header"><div class="sec-title">Editor's choice</div><div class="see-more" onclick="goToAll()">See more</div></div>
            <div id="grid-editor" class="app-row"></div>
        </div>
    </div>
</div>

<div id="all-view" style="display:none; padding: 20px;">
    <h2 style="margin-bottom:15px;">All projects</h2>
    <div id="grid-all" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:15px; row-gap: 25px;"></div>
</div>

<div id="detailPage" class="modal-full"><div id="detailContent"></div></div>

<!-- Profile modal: set username & avatar + settings (language, dark mode, account picture) -->
<div id="profileModal" class="modal-full" onclick="if(event.target===this) closeProfileModal()">
  <div class="modal-content" onclick="event.stopPropagation()">

    <div style="display:flex; justify-content:flex-start; align-items:center; gap:12px;" class="profile-header">
      <div class="profile-ring">
        <img id="profilePreview" src="" class="profile-preview-lg" alt="Profile preview" loading="lazy">
      </div>
      <div class="profile-meta">
        <h3 id="profileDisplayName">Your Profile</h3>
        <div class="sub" id="profileSub">Set your display name, profile image and appearance.</div>
        <div class="profile-actions">
          <button class="remove-photo-btn" onclick="removeProfilePhoto()">Remove photo</button>
          <button class="remove-photo-btn" onclick="document.getElementById('profile_file').click()">Change photo</button>
        </div>
      </div>
    </div>

    <div style="margin-top:12px;">
      <input id="profile_name" placeholder="prime x cheats" />
      <label style="font-size:13px;margin-top:6px;">Profile Image (optional)</label>
      <input id="profile_file" type="file" accept="image/*" />
      <!-- NOTE: search input removed from profile modal as requested -->
    </div>

    <div class="profile-settings-card">
        <div style="font-weight:800; margin-bottom:8px;">Settings</div>

        <!-- Language and Dark Mode removed as requested -->

        <div class="setting-row" style="margin-top:8px;">
            <div>
                <div class="setting-label">Account Picture</div>
                <div class="setting-sub">Enable to show uploaded picture; disable to use letter-avatar</div>
            </div>
            <div>
                <div id="profile_usepic_toggle" class="toggle-switch" role="switch" aria-checked="true" onclick="toggleProfileUsePic(this)">
                    <div class="knob"></div>
                </div>
            </div>
        </div>

        <!-- Social links added to profile modal as requested -->
        <div style="margin-top:12px;" class="profile-links-block">
            <div style="font-weight:800; margin-bottom:8px;">Links</div>
            <div style="display:flex; flex-direction:column; gap:8px;">
                <a class="share-btn" href="https://youtube.com/@flashgamingff7?si=Bb1xAI18KGhcaTsX" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation();"> <i class="fa-brands fa-youtube"></i> YouTube</a>
                <a class="share-btn" href="https://www.instagram.com/flash_gaming_ff7?igsh=dDI1dzB3czQ0NTE5" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation();"><i class="fa-brands fa-instagram"></i> Instagram</a>
                <a class="share-btn" href="https://t.me/+c3piaAf4FeA4YWRl" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation();"><i class="fa-brands fa-telegram"></i> Telegram channel</a>
                <a class="share-btn" href="https://t.me/+c3piaAf4FeA4YWRl" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation();"><i class="fa-solid fa-users"></i> Telegram group</a>
            </div>
        </div>

        <!-- Unique profile link display + copy -->
        <div style="margin-top:12px;" class="profile-link-block">
            <div style="font-weight:800; margin-bottom:8px;">Profile Link</div>
            <div style="display:flex; gap:8px; align-items:center;">
                <input id="profileLinkInput" readonly style="flex:1; border-radius:10px; padding:8px;" title="Your unique profile link" />
                <button class="share-btn" onclick="copyProfileLink(event)" title="Copy profile link"><i class="fa-solid fa-link"></i> Copy</button>
            </div>
            <div style="font-size:12px;color:gray;margin-top:6px;">This link is unique to your account and can be shared.</div>
        </div>

    </div>

    <div style="margin-top:12px; display:flex; gap:10px;">
      <button id="profileSaveBtn" class="btn-download" onclick="saveProfile()">Save Profile & Settings</button>
      <button class="share-btn" style="align-self:center;" onclick="closeProfileModal();">Back</button>
    </div>
  </div>
</div>

<div id="zoomOverlay" class="zoom-overlay" onclick="this.style.display='none'">
    <i class="fa-solid fa-arrow-left close-zoom"></i>
    <img id="zoomImg" src="" loading="lazy">
</div>

<!-- Updated bottom nav markup to separate icon and label (easier styling, matches screenshot) -->
<nav class="bottom-nav">
    <div class="nav-item active" id="nav-home" onclick="tab('home', this)"><i class="fa-solid fa-house"></i><div class="nav-label">Home</div></div>
    <div class="nav-item" id="nav-all" onclick="tab('all', this)"><i class="fa-solid fa-layer-group"></i><div class="nav-label">All apps</div></div>
    <div class="nav-item" id="nav-search" onclick="showSearchSamples(this)"><i class="fa-solid fa-search"></i><div class="nav-label">Search</div></div>
    <div class="nav-item" id="nav-news" onclick="tab('news', this)"><i class="fa-solid fa-newspaper"></i><div class="nav-label">News</div></div>

    <!-- Group nav item removed (world chat deleted) -->

    <!-- Upload nav item removed as requested -->
    <!-- Bottom profile removed per request: only top header profile will be used -->
</nav>

<script type="module">
/*
  Changes made for user:
  - Removed drawer button and the drawer panel from the DOM/CSS.
  - Updated news thumbnail styling so images size to their intrinsic content (wrap_content-like).
  - Fixed and hardened comment posting functions (postComment & postNewsComment):
      * Always save comment locally for instant UI update.
      * Attempt deterministic Firebase set, fallback to push, fallback to Realtime DB REST (PUT/POST).
      * If all remote writes fail, inform user that the comment is saved locally and will sync when possible.
      * This ensures comments become public (all users will see them) when Firebase writes succeed.
  - If a News item contains a YouTube link (in its `link` or `img` field), the news card will now embed the YouTube player
    directly in the news list. This implements the user's request: "News main YouTube URL dekhega to video dikhna chahie".
  - No other behavior changed; drawer-related JS helper calls gracefully check element existence before use.
*/

/* Firebase imports */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
import { push, ref as rdbRef, set, update } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
import { getStorage, ref as storageRef, uploadBytes, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyDfh2YV8a55P9EaBaVwCSW3L9q11x_4sz4",
  authDomain: "mega-boost-official-website.firebaseapp.com",
  databaseURL: "https://prime-x-cheats-default-rtdb.firebaseio.com",
  projectId: "prime-x-cheats",
  storageBucket: "prime-x-cheats.firebasestorage.app",
  messagingSenderId: "92474703885",
  appId: "1:92474703885:android:3d30e7498d7edd01bbd544",
  measurementId: "G-LN9QJ0Y938"
};

let fbAvailable = false;
let rdb = null;
let storage = null;
try {
    const fbApp = initializeApp(firebaseConfig);
    rdb = getDatabase(fbApp);
    storage = getStorage(fbApp);
    fbAvailable = true;
    console.log("Firebase initialized (read-only on index).");
} catch (e) {
    console.warn("Firebase init failed - fallback to local/jsonbin only.", e);
}

/* GLOBAL API CONFIG (jsonbin for app catalog backup) */
const BIN_ID = '658b0f80dc7465401889980b';
const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
const DB_KEY = "MEGA_STORE_FINAL_DB";
const COMMENT_KEY = "MEGA_STORE_COMMENTS";
const USER_NAME_KEY = "MEGA_STORE_USER_NAME";
const USER_AVATAR_KEY = "MEGA_STORE_USER_AVATAR"; // new key for profile avatar
// language from profile modal per request
const USER_USE_PIC_KEY = "MEGA_STORE_USE_ACCOUNT_PIC"; // whether to use uploaded avatar as account pic
const NEWS_KEY = "MEGA_STORE_NEWS"; // new key for news
const LIKES_KEY = "MEGA_STORE_LIKES";
const VIEWS_KEY = "MEGA_STORE_VIEWS";

/* in-memory caches */
let db = JSON.parse(localStorage.getItem(DB_KEY)) || [];
let commentsDB = JSON.parse(localStorage.getItem(COMMENT_KEY)) || {};
let newsDB = JSON.parse(localStorage.getItem(NEWS_KEY)) || [];
let likesDB = JSON.parse(localStorage.getItem(LIKES_KEY)) || {}; // structure: { idKey: { userId: true } }
let viewsDB = JSON.parse(localStorage.getItem(VIEWS_KEY)) || {}; // structure: { idKey: { userId: true } }

let currentTab = 'home';
let currentDetailId = null;

/* small guard variable to ignore pop events triggered by programmatic history.back() when closing modal */
let ignoreNextPop = false;

/* Reply state removed along with world chat */

/* If Firebase available, attach listeners for apps, comments, news, likes, views (read-only listeners) */
if (fbAvailable && rdb) {
    // apps listener -> keep db updated in real time
    try {
        onValue(ref(rdb, 'apps'), (snap) => {
            const val = snap.val() || {};
            db = Object.keys(val).map(k => val[k]);
            db.sort((a,b) => (b.id || 0) - (a.id || 0));
            localStorage.setItem(DB_KEY, JSON.stringify(db));
            render();
            const idFromUrl = getAppIdFromUrl();
            if (idFromUrl && !currentDetailId) {
                const idNum = Number(idFromUrl);
                if (!isNaN(idNum)) openDetail(idNum, true);
            }
        }, (err) => {
            console.warn("Firebase apps listener error:", err);
        });
    } catch (e) {
        console.warn("Unable to attach apps listener:", e);
    }

    // comments listener -> keep commentsDB updated
    try {
        onValue(ref(rdb, 'comments'), (snap) => {
            const val = snap.val() || {};
            commentsDB = val;
            localStorage.setItem(COMMENT_KEY, JSON.stringify(commentsDB));
            if (currentDetailId) openDetail(currentDetailId, true);
            // refresh news UI as well (news comments might have changed)
            renderNews();
        }, (err) => {
            console.warn("Firebase comments listener error:", err);
        });
    } catch (e) {
        console.warn("Unable to attach comments listener:", e);
    }

    // news listener -> keep newsDB updated
    try {
        onValue(ref(rdb, 'news'), (snap) => {
            const val = snap.val() || {};
            // convert to array
            newsDB = Object.keys(val).map(k => val[k]);
            newsDB.sort((a,b) => (b.id || 0) - (a.id || 0));
            localStorage.setItem(NEWS_KEY, JSON.stringify(newsDB));
            renderNews();
        }, (err) => {
            console.warn("Firebase news listener error:", err);
        });
    } catch (e) {
        console.warn("Unable to attach news listener:", e);
    }

    // likes listener -> keep likesDB updated
    try {
        onValue(ref(rdb, 'likes'), (snap) => {
            const val = snap.val() || {};
            // val structure expected: { idKey: { userId: true } }
            likesDB = val;
            localStorage.setItem(LIKES_KEY, JSON.stringify(likesDB));
            // update UI: detail counts + grid
            if (currentDetailId) updateDetailStats(currentDetailId);
            render();
            renderNews();
        }, (err) => {
            console.warn("Firebase likes listener error:", err);
        });
    } catch (e) {
        console.warn("Unable to attach likes listener:", e);
    }

    // views listener -> keep viewsDB updated
    try {
        onValue(ref(rdb, 'views'), (snap) => {
            const val = snap.val() || {};
            // val structure expected: { idKey: { userId: true } }
            viewsDB = val;
            localStorage.setItem(VIEWS_KEY, JSON.stringify(viewsDB));
            if (currentDetailId) updateDetailStats(currentDetailId);
            render();
            renderNews();
        }, (err) => {
            console.warn("Firebase views listener error:", err);
        });
    } catch (e) {
        console.warn("Unable to attach views listener:", e);
    }
}

/* Theme + Animation helpers (dark mode removed) */
function setTheme(theme) {
    const body = document.body;
    body.classList.remove('dark-mode', 'light-mode');
    // Force light mode only
    body.classList.add('light-mode');
    localStorage.setItem('MEGA_THEME', 'light');
}
window.setTheme = setTheme;

// toggles disabled because dark mode removed
function toggleTheme() {
    // no-op: theme is always light
    setTheme('light');
}
window.toggleTheme = toggleTheme;
window.toggleNightMode = toggleTheme;

/* Utility functions */
function getAppIdFromUrl() {
    try {
        const url = new URL(window.location.href);
        const q = url.searchParams.get('app');
        if (q) return q;
        if (window.location.hash && window.location.hash.includes('app=')) {
            const parts = window.location.hash.replace('#','').split('=');
            if (parts[0] === 'app' && parts[1]) return parts[1];
        }
    } catch (e) {}
    return null;
}
function clearAppFromUrl() {
    try { history.replaceState({}, '', location.pathname); } catch (e) {}
}
function escapeHtml(str) {
    if (typeof str !== 'string') return '';
    return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
}
/* Linkify function for rendering clickable links in descriptions */
function linkify(text) {
    if (!text) return '';
    const escaped = escapeHtml(text);
    const withBreaks = escaped.replace(/\r\n|\r|\n/g, '<br>');
    const urlRegex = /(\b(https?:\/\/|www\.)[^\s<]+)/gi;
    const linked = withBreaks.replace(urlRegex, function(m) {
        let url = m;
        if (!/^https?:\/\//i.test(url)) {
            url = 'https://' + url;
        }
        return `<a href="${url}" target="_blank" rel="noopener noreferrer">${m}</a>`;
    });
    return linked;
}
/* truncate plain text safely before linkifying */
function truncateText(s, len) {
    if (!s) return '';
    if (s.length <= len) return s;
    return s.slice(0, len).trim() + 'â€¦';
}

/* --- YouTube helper: extract video id from common YouTube URL forms --- */
function extractYouTubeId(url) {
    if (!url || typeof url !== 'string') return null;
    // Normalize
    try {
        // Quick regex to capture 11-char video id in common URL forms
        const m = url.match(/(?:youtu\.be\/|youtube(?:-nocookie)?\.com\/(?:watch\?(?:.*&)?v=|embed\/|v\/))([A-Za-z0-9_-]{11})/i);
        if (m && m[1]) return m[1];
        // Also check for v= query param in case of complex URLs
        const parsed = new URL(url, location.href);
        const v = parsed.searchParams.get('v');
        if (v && /^[A-Za-z0-9_-]{11}$/.test(v)) return v;
    } catch (e) {
        // ignore parsing errors
    }
    return null;
}

/* deterministic color generation based on name */
function colorFromString(s) {
    let h = 0;
    for (let i = 0; i < s.length; i++) { h = s.charCodeAt(i) + ((h << 5) - h); }
    const hue = Math.abs(h) % 360;
    return `hsl(${hue} 70% 50%)`;
}

/* Create a letter-avatar dataURL (circle with initials) - improved gradient style and bolder text for nicer look */
function createLetterAvatar(name, size = 128, bgColor, textColor = '#fff') {
    const initials = (name || '').trim().split(/\s+/).slice(0,2).map(p => p[0]?.toUpperCase() ?? '').join('').slice(0,2) || 'U';
    const canvas = document.createElement('canvas');
    canvas.width = size;
    canvas.height = size;
    const ctx = canvas.getContext('2d');

    // gradient background for nicer look (instagram-like warmth)
    const g = ctx.createLinearGradient(0,0,size,size);
    if (bgColor) {
        g.addColorStop(0, bgColor);
        g.addColorStop(1, shadeColor(bgColor, -20));
    } else {
        // a pleasing multi-stop gradient derived from name
        const base = colorFromString(name || 'user');
        g.addColorStop(0, base);
        g.addColorStop(0.5, shadeColor(base, -8));
        g.addColorStop(1, shadeColor(base, 12));
    }
    ctx.fillStyle = g;
    // circle fill
    ctx.beginPath();
    ctx.arc(size/2, size/2, size/2, 0, Math.PI * 2);
    ctx.fill();

    ctx.fillStyle = textColor;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    // bold, crisp font
    ctx.font = `bold ${Math.floor(size*0.45)}px sans-serif`;
    ctx.fillText(initials, size/2, size/2 + (size*0.02));
    return canvas.toDataURL('image/png');
}

/* small color adjuster for gradients */
function shadeColor(hslOrHex, percent) {
    // If hsl format, slightly adjust lightness
    if (hslOrHex.startsWith('hsl')) {
        try {
            const parts = hslOrHex.match(/hsl\((\d+)\s+(\d+)%\s+(\d+)%\)/);
            if (parts) {
                const h = Number(parts[1]), s = Number(parts[2]), l = Math.min(100, Math.max(0, Number(parts[3]) + percent));
                return `hsl(${h} ${s}% ${l}%)`;
            }
        } catch(e){}
    }
    // fallback hex handling (simple)
    try {
        let c = hslOrHex.replace('#','');
        if (c.length === 3) c = c.split('').map(ch=>ch+ch).join('');
        const num = parseInt(c,16);
        let r = (num >> 16) + Math.round(255*percent/100);
        let g = ((num >> 8) & 0x00FF) + Math.round(255*percent/100);
        let b = (num & 0x0000FF) + Math.round(255*percent/100);
        r = Math.min(255, Math.max(0, r));
        g = Math.min(255, Math.max(0, g));
        b = Math.min(255, Math.max(0, b));
        return `#${(r<<16 | g<<8 | b).toString(16).padStart(6,'0')}`;
    } catch(e) {
        return hslOrHex;
    }
}

/* get stored profile (name + avatar + useAccountPic) */
function getStoredProfile() {
    return {
        name: localStorage.getItem(USER_NAME_KEY) || '',
        avatar: localStorage.getItem(USER_AVATAR_KEY) || '',
        lang: 'en', // language removed from modal; default to English
        useAccountPic: (localStorage.getItem(USER_USE_PIC_KEY) || 'true') === 'true'
    };
}

/* set header & nav profile UI */
function refreshProfileUI() {
    const { name, avatar, useAccountPic } = getStoredProfile();
    const headerAvatar = document.getElementById('headerAvatar');

    if (useAccountPic && avatar && headerAvatar) {
        headerAvatar.src = avatar;
    } else if (headerAvatar) {
        headerAvatar.src = createLetterAvatar(name || 'User', 72);
    }

    // profile modal preview (if open)
    const profilePreview = document.getElementById('profilePreview');
    if (profilePreview) {
        const src = (useAccountPic && avatar) ? avatar : createLetterAvatar(name || 'User', 128);
        profilePreview.src = src;
    }

    // profile display name in modal
    const profileDisplay = document.getElementById('profileDisplayName');
    if (profileDisplay) profileDisplay.innerText = name || 'Your Profile';
}
window.refreshProfileUI = refreshProfileUI;

/* Ensure we have a stable userId for per-account constraints.
   Prefer USER_NAME_KEY if present; otherwise fallback to generated ID stored in localStorage as MEGA_USER_ID.
*/
function ensureUserId() {
    let userName = localStorage.getItem(USER_NAME_KEY);
    if (userName && userName.trim() !== '') {
        return 'u_' + userName.trim().replace(/\s+/g, '_').toLowerCase();
    }
    let uid = localStorage.getItem('MEGA_USER_ID');
    if (!uid) {
        uid = 'anon_' + Date.now() + '_' + Math.floor(Math.random()*10000);
        localStorage.setItem('MEGA_USER_ID', uid);
    }
    return uid;
}

/* Generate shareable unique profile link for current user */
function generateProfileLink() {
    const uid = ensureUserId();
    // Use query param 'profile' to avoid conflict with app= param
    const base = `${location.origin}${location.pathname}`;
    return `${base}?profile=${encodeURIComponent(uid)}`;
}

/* copy profile link to clipboard */
async function copyProfileLink(evt) {
    evt && evt.stopPropagation && evt.stopPropagation();
    const url = generateProfileLink();
    try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(url);
            alert('Profile link copied to clipboard.');
            return;
        }
    } catch (e) {
        // fallback below
    }
    // fallback prompt
    prompt('Copy your profile link:', url);
}
window.copyProfileLink = copyProfileLink;

/* Initialize app: restore theme, load local cache, then jsonbin fallback */
async function initApp() {
    // Force theme to light so app shows white/light theme by default.
    setTheme('light');
    const savedAnim = localStorage.getItem('MEGA_BG_ANIM') || '15';
    document.documentElement.style.setProperty('--bg-animation-duration', savedAnim + 's');

    // Load likes/views caches from localStorage
    likesDB = JSON.parse(localStorage.getItem(LIKES_KEY)) || likesDB;
    viewsDB = JSON.parse(localStorage.getItem(VIEWS_KEY)) || viewsDB;

    render();
    renderNews();

    // initialize custom select AFTER DOM + render
    try { initCustomSelect(); } catch(e){ console.warn('initCustomSelect error', e); }

    // init profile UI
    refreshProfileUI();

    // initialize profile toggles to reflect stored settings for accessibility (only use-pic toggle now)
    try { initProfileToggles(); } catch(e) {}

    // offline handling
    setupOfflineWatcher();

    // Ensure the search input shows sample apps when focused so user sees apps immediately
    try {
        const si = document.getElementById('searchInput');
        if (si) {
            si.addEventListener('focus', () => {
                // Show search samples when focusing the header search so apps are visible
                const navSearchEl = document.getElementById('nav-search');
                showSearchSamples(navSearchEl);
            });
        }
    } catch (e) {
        console.warn('searchInput focus hook failed', e);
    }

    const idFromUrl = getAppIdFromUrl();
    if (idFromUrl) {
        const idNum = Number(idFromUrl);
        if (!isNaN(idNum)) {
            const exists = db.find(x => Number(x.id) === idNum);
            if (exists) openDetail(idNum, true);
        }
    }

    try {
        const response = await fetch(API_URL + '/latest');
        const result = await response.json();
        if (result.record && Array.isArray(result.record) && result.record.length) {
            if (!fbAvailable || (fbAvailable && (!db || db.length === 0))) {
                db = result.record;
                localStorage.setItem(DB_KEY, JSON.stringify(db));
                render();
                const idFromUrl2 = getAppIdFromUrl();
                if (idFromUrl2) {
                    const idNum = Number(idFromUrl2);
                    if (!isNaN(idNum)) openDetail(idNum, true);
                }
            }
        }
    } catch (error) {
        console.log("jsonbin fetch failed, using local data.");
    }

    // Hide profile modal Links & Profile Link sections (do not delete code, hide them)
    try { hideProfileLinksAndProfileLink(); } catch(e) { console.warn('hideProfileLinks failed', e); }
}
window.initApp = initApp;

/* popstate handler
   - If profile modal open, hide it (so phone back closes modal first).
   - If zoom overlay open, hide it first.
   - Otherwise fall back to previous behavior.
*/
window.onpopstate = function(event) {
    if (ignoreNextPop) { ignoreNextPop = false; return; }

    const profileModal = document.getElementById('profileModal');
    if (profileModal && profileModal.style.display === 'flex') {
        profileModal.style.display = 'none';
        return;
    }

    const zoom = document.getElementById('zoomOverlay');
    if (zoom && zoom.style.display === 'flex') {
        zoom.style.display = 'none';
        return;
    }

    closeAll();
};

/* Close modals and clear detail state */
function closeAll() {
    document.querySelectorAll('.modal, .modal-full').forEach(m => m.style.display='none');
    currentDetailId = null;
    clearAppFromUrl();
}
window.closeAll = closeAll;

/* Helper: safe count accessor */
function countFor(obj, key) {
    const group = obj && obj[key] ? obj[key] : {};
    return Object.keys(group).length;
}

/* ------------------ Icon loading helpers ------------------ */
/* Called from inline image onload */
function onIconLoad(img) {
    try {
        const box = img.closest('.icon-box');
        if (box) box.classList.remove('loading');
        img.style.opacity = '1';
    } catch(e) {}
}
window.onIconLoad = onIconLoad;

/* Called from inline image onerror */
function onIconError(img) {
    try {
        // keep loading visual if desired, then set placeholder - placeholder will trigger onload and remove loading
        const box = img.closest('.icon-box');
        if (box) box.classList.add('loading');
        img.src = 'https://via.placeholder.com/150';
        // allow placeholder to load (onload will remove 'loading')
    } catch(e) {}
}
window.onIconError = onIconError;

/* for profile header avatar fallback */
function onProfileAvatarError(img) {
    try {
        const stored = getStoredProfile();
        img.src = createLetterAvatar(stored.name || 'User', 72);
    } catch (e) {}
}
window.onProfileAvatarError = onProfileAvatarError;

/* Screenshot loading handlers (NEW)
   - Adds shimmer until screenshot image fires onload. On error, replace with placeholder.
*/
function onSSLoad(img) {
    try {
        img.classList.remove('loading');
        img.style.opacity = '1';
    } catch(e) {}
}
window.onSSLoad = onSSLoad;

function onSSLoadError(img) {
    try {
        img.classList.remove('loading');
        img.src = 'https://via.placeholder.com/600x400';
    } catch(e) {}
}
window.onSSLoadError = onSSLoadError;

/* ------------------ User: compress + upload with progress helpers ------------------ */

// Compress image file to a Blob (WebP preferred). Returns Blob.
function compressImageUser(file, maxWidth = 1024, quality = 0.75, mimeType = 'image/webp') {
  return new Promise((resolve, reject) => {
    if (!file || !file.type || !file.type.startsWith('image/')) return reject(new Error('Not an image'));
    const img = new Image();
    const reader = new FileReader();
    reader.onerror = (e) => reject(e);
    reader.onload = () => {
      img.onload = () => {
        try {
          const scale = Math.min(1, maxWidth / img.width);
          const w = Math.round(img.width * scale);
          const h = Math.round(img.height * scale);
          const canvas = document.createElement('canvas');
          canvas.width = w;
          canvas.height = h;
          const ctx = canvas.getContext('2d');
          // white background for images with transparency to avoid big webp differences
          ctx.fillStyle = '#ffffff';
          ctx.fillRect(0, 0, w, h);
          ctx.drawImage(img, 0, 0, w, h);
          canvas.toBlob((blob) => {
            if (!blob) return reject(new Error('Compression failed'));
            resolve(blob);
          }, mimeType, quality);
        } catch (err) {
          reject(err);
        }
      };
      img.onerror = (e) => reject(e);
      img.src = reader.result;
    };
    reader.readAsDataURL(file);
  });
}

// Convert file to dataURL with progress reporting via onProgress(percent)
function fileToDataURLWithProgressUser(file, onProgress) {
  return new Promise((res, rej) => {
    const reader = new FileReader();
    reader.onprogress = (ev) => {
      if (ev.lengthComputable && typeof onProgress === 'function') {
        const p = Math.round((ev.loaded / ev.total) * 100);
        try { onProgress(p); } catch (e) {}
      }
    };
    reader.onload = () => res(reader.result);
    reader.onerror = rej;
    reader.readAsDataURL(file);
  });
}

// Upload (or convert) file with progress callback. Returns URL (downloadURL or dataURL).
async function uploadFileToStorage_User(file, path, onProgress) {
  if (!file) return '';
  let blob;
  try {
    // Default compression for general uploads; but if file already compressed small, compressImageUser will reduce size
    // For non-image files (e.g. audio) compressImageUser will reject and we fallback to file
    blob = await compressImageUser(file, 1024, 0.75, 'image/webp');
  } catch (e) {
    blob = file;
  }

  if (fbAvailable && storage) {
    try {
      const sRef = storageRef(storage, path);
      const uploadTask = uploadBytesResumable(sRef, blob, { contentType: blob.type || file.type });
      return await new Promise((resolve, reject) => {
        uploadTask.on('state_changed',
          (snapshot) => {
            const percent = snapshot.totalBytes ? Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100) : 0;
            if (typeof onProgress === 'function') onProgress(percent);
          },
          (error) => {
            console.warn('Firebase upload failed - fallback to dataURL', error);
            // Mark failure by rejecting so caller can handle error state if desired
            fileToDataURLWithProgressUser(file, onProgress).then(url => {
                resolve(url);
            }).catch(err => reject(err));
          },
          async () => {
            try {
              const url = await getDownloadURL(uploadTask.snapshot.ref);
              if (typeof onProgress === 'function') onProgress(100);
              resolve(url);
            } catch (e) { reject(e); }
          }
        );
      });
    } catch (e) {
      console.warn('uploadFileToStorage_User firebase path error', e);
      return await fileToDataURLWithProgressUser(file, onProgress);
    }
  } else {
    return await fileToDataURLWithProgressUser(file, onProgress);
  }
}

// Sequential uploader for user uploads
async function uploadFilesSequential_User(uploadList, overallProgressCb) {
  const total = uploadList.length || 0;
  let done = 0;
  const results = [];
  for (let i = 0; i < uploadList.length; i++) {
    const item = uploadList[i];
    try {
      const url = await uploadFileToStorage_User(item.file, item.path, (filePercent) => {
        const overall = total ? Math.round(((done + (filePercent / 100)) / total) * 100) : 100;
        if (typeof overallProgressCb === 'function') overallProgressCb(overall, done, filePercent, i);
      });
      results.push(url);
      done++;
      if (typeof overallProgressCb === 'function') overallProgressCb(Math.round((done / total) * 100), done, 100, i);
    } catch (e) {
      console.warn('uploadFilesSequential_User error for item', item, e);
      results.push('');
    }
  }
  return results;
}

function setUserUploadProgress(text) {
  const el = document.getElementById('uploadProgressUser');
  if (el) el.innerText = text;
}

/* ---------------- end user upload helpers ------------------ */

/* Small helper: attempt to write via Realtime DB REST API */
async function writeToRealtimeDBRest(path, data, method = 'PUT') {
    // path should not start with a slash, e.g. 'comments/appId/key'
    try {
        const base = (firebaseConfig && firebaseConfig.databaseURL) ? firebaseConfig.databaseURL.replace(/\/$/,'') : null;
        if (!base) throw new Error('No realtime DB URL');
        const url = `${base}/${path}.json`;
        const res = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        if (!res.ok) {
            const text = await res.text();
            throw new Error('REST write failed: ' + res.status + ' ' + text);
        }
        const json = await res.json();
        return json;
    } catch (e) {
        console.warn('writeToRealtimeDBRest failed', e);
        throw e;
    }
}

/* ------------------ Render + News + Detail logic (unchanged except news image CSS updated & YouTube embed) ------------------ */

function render() {
    const grids = {
        "Trending": "grid-trending",
        "New & Updated": "grid-new",
        "Editor's choice": "grid-editor",
        "New": "grid-new-main", // <-- added main New mapping
        "Sylhet": "grid-new-main" // Sylhet items also go into the New main section as requested
    };
    const counts = { "Trending": 0, "New & Updated": 0, "Editor's choice": 0, "New": 0, "Sylhet": 0 };
    Object.values(grids).forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = "";
    });
    const topEl = document.getElementById('grid-top'); if (topEl) topEl.innerHTML = "";
    const allEl = document.getElementById('grid-all'); if (allEl) allEl.innerHTML = "";

    // If db is empty show skeleton placeholders in each section (per user's request)
    if (!db || db.length === 0) {
        // Top banner skeletons
        if (topEl) {
            topEl.innerHTML = `<div class="skeleton skeleton-top"></div><div class="skeleton skeleton-top" style="opacity:0.85"></div>`;
        }
        // for horizontally scrolling sections show a few small skeleton cards
        ['grid-new-main','grid-trending','grid-new','grid-editor'].forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            let s = '';
            for (let i=0;i<5;i++){
                s += `<div class="skeleton-card"><div class="skeleton skeleton-icon"></div><div class="skeleton skeleton-name"></div></div>`;
            }
            el.innerHTML = s;
        });
        // All grid skeleton
        if (allEl) {
            let s = '';
            for (let i=0;i<6;i++){
                s += `<div style="background:transparent;"><div class="skeleton-card" style="margin:8px 0;"><div class="skeleton skeleton-icon"></div><div class="skeleton skeleton-name" style="width:90%"></div></div></div>`;
            }
            allEl.innerHTML = s;
        }
        return;
    }

    db.forEach(p => {
        // compute counts from likesDB / viewsDB
        const likesCount = countFor(likesDB, p.id);
        const viewsCount = countFor(viewsDB, p.id);

        const statsHTML = `<div class="app-stats">
                              <div class="stat" title="Views"><i class="fa-solid fa-eye"></i><div class="num">${escapeHtml(String(viewsCount || 0))}</div></div>
                              <div class="stat" title="Likes"><i class="fa-solid fa-heart"></i><div class="num">${escapeHtml(String(likesCount || 0))}</div></div>
                           </div>`;

        // icon-box starts with "loading" class and image has onload/onerror hooks to toggle
        const html = `<div class="app-card" onclick="openDetail(${p.id})">
                        <div class="icon-box loading"><img src="${p.icon}" loading="lazy" decoding="async" onload="onIconLoad(this)" onerror="onIconError(this)"></div>
                        <div class="app-name">${escapeHtml(p.name)}</div>
                        ${statsHTML}
                      </div>`;

        if (p.cat === "Top Project") {
            const topHTML = `<div class="top-banner-card" onclick="openDetail(${p.id})"><img src="${p.banner || p.icon}" loading="lazy" decoding="async" onerror="this.src='https://via.placeholder.com/300x150'"><div class="banner-info">${escapeHtml(p.name)}</div></div>`;
            if (topEl) topEl.innerHTML += topHTML;
            // also add to All projects grid
            if (allEl) allEl.innerHTML += html;
        } else {
            // If p.cat matches one of our grid keys and we haven't exceeded a short preview count, add to that grid
            if (grids[p.cat] && counts[p.cat] < 5) {
                const el = document.getElementById(grids[p.cat]);
                if (el) el.innerHTML += html;
                counts[p.cat]++;
            }
            if (allEl) allEl.innerHTML += html;
        }
    });
}

/* Helper to create consistent key for news entries inside likes/comments/views caches:
   We'll store news entries under keys like "news_<id>" so existing firebase listeners under
   /likes /comments /views pick them up if present in the database.
*/
function getNewsKey(id) {
    return `news_${id}`;
}

/* Render News list (read-only)
   News card includes actions (like, comment, share, bookmark), likes count, and inline comments + input similar to provided screenshot.
   When newsDB is empty show skeleton placeholders.
   If a news item's link or image is a YouTube URL the player will be embedded directly in the news card.
*/
function renderNews(filtered) {
    const list = document.getElementById('newsList');
    if (!list) return;
    const items = Array.isArray(filtered) ? filtered : newsDB;

    if (!items || items.length === 0) {
        // show skeleton news cards (loading placeholders)
        const skeletons = [];
        for (let i=0;i<3;i++){
            skeletons.push(`
                <div class="news-card">
                    <div class="news-row">
                        <div class="news-thumb skeleton skeleton-news"></div>
                        <div class="news-meta">
                            <div class="skeleton skeleton-name" style="height:18px;width:60%"></div>
                            <div class="skeleton-line skeleton"></div>
                            <div class="skeleton-line skeleton" style="width:80%"></div>
                            <div style="display:flex; gap:8px; margin-top:8px;">
                                <div class="skeleton skeleton-small-line" style="width:120px;height:36px;border-radius:8px;"></div>
                                <div style="flex:1"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `);
        }
        list.innerHTML = skeletons.join('');
        return;
    }

    let html = '';
    items.forEach(n => {
        const idKey = getNewsKey(n.id);
        const likesCount = countFor(likesDB, idKey);

        // fetch comments for this news (commentsDB may store arrays or object maps)
        const commsObj = commentsDB[idKey] || {};
        let commsArr = [];
        if (Array.isArray(commsObj)) {
            commsArr = commsObj;
        } else {
            commsArr = Object.keys(commsObj).map(k => ({ id: k, ...commsObj[k] }));
            commsArr.sort((a,b) => {
                const da = a.date ? new Date(a.date) : 0;
                const dbb = b.date ? new Date(b.date) : 0;
                return dbb - da;
            });
        }

        // Build preview of up to 3 comments (with avatar support)
        let commentsPreviewHTML = '';
        if (commsArr.length === 0) {
            commentsPreviewHTML = `<div id="news_comments_${n.id}" class="news-comments-placeholder">No comments yet</div>`;
        } else {
            const preview = commsArr.slice(0,3).map(c => {
                const av = c.avatar || createLetterAvatar(c.name || 'Anonymous', 64);
                return `
                  <div class="comment-item" style="background:transparent; border:none; padding:6px 0;">
                    <div class="comment-row">
                      <img src="${av}" class="comment-avatar" loading="lazy">
                      <div class="comment-body">
                        <div class="comment-user">${escapeHtml(c.name || 'Anonymous')}</div>
                        <div class="comment-text">${escapeHtml(c.comment || '')}</div>
                        <div class="comment-date">${ formatDate(c.date) }</div>
                      </div>
                    </div>
                  </div>
                `;
            }).join('');
            commentsPreviewHTML = `<div id="news_comments_${n.id}">${preview}</div>`;
            const moreCount = Math.max(0, commsArr.length - 3);
            if (moreCount > 0) {
                commentsPreviewHTML += `<button id="news_show_more_btn_${n.id}" class="show-more-comments" onclick="toggleNewsComments(${n.id}); event.stopPropagation();">Show ${moreCount} more comment${moreCount>1?'s':''}</button>
                <div id="news_all_comments_${n.id}" class="all-comments"></div>`;
            } else {
                // make sure hidden full container exists for consistency
                commentsPreviewHTML += `<div id="news_all_comments_${n.id}" class="all-comments"></div>`;
            }
        }

        const stored = getStoredProfile();
        const userAvatarPreview = (stored.useAccountPic && stored.avatar) ? stored.avatar : createLetterAvatar(stored.name || 'U', 64);

        // New: detect YouTube links and embed the player in the news-thumb if present.
        const youtubeId = extractYouTubeId(n.link || '') || extractYouTubeId(n.img || '');
        let thumbHtml = '';
        if (youtubeId) {
            // embed responsive iframe (16:9)
            thumbHtml = `
                <div class="news-thumb">
                  <div style="position:relative;padding-top:56.25%;">
                    <iframe
                      loading="lazy"
                      src="https://www.youtube.com/embed/${youtubeId}"
                      frameborder="0"
                      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                      allowfullscreen
                      style="position:absolute; top:0; left:0; width:100%; height:100%; border:0;">
                    </iframe>
                  </div>
                </div>
            `;
        } else {
            // normal image thumbnail
            const imgSrc = n.img || 'https://via.placeholder.com/800x420';
            thumbHtml = `<div class="news-thumb"><img src="${imgSrc}" alt="${escapeHtml(n.title)}" loading="lazy" decoding="async" onerror="this.src='https://via.placeholder.com/800x420'"></div>`;
        }

        html += `<div class="news-card" onclick="event.stopPropagation();">
            <div class="news-row">
                ${thumbHtml}
                <div class="news-meta">
                    <div class="news-title">${escapeHtml(n.title)}</div>
                    <div class="news-desc">${linkify(truncateText(n.desc || '', 240))}</div>
                    <div style="display:flex; gap:8px; margin-top:6px; align-items:center;">
                        ${n.link && !extractYouTubeId(n.link) ? `<a href="${n.link}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation(); registerNewsView(${n.id});" class="open-news-link">Open Link</a>` : ''}
                    </div>

                    <div class="news-actions" style="margin-top:12px;">
                        <div class="icon" title="Like" onclick="toggleNewsLike(${n.id}, event)"><i id="news_like_icon_${n.id}" class="fa-regular fa-heart"></i></div>
                        <div class="icon" title="Comment" onclick="document.getElementById('news_ctext_${n.id}').focus(); event.stopPropagation();"><i class="fa-regular fa-comment"></i></div>
                        <div class="icon" title="Share" onclick="shareNews(${n.id}); event.stopPropagation();"><i class="fa-solid fa-paper-plane"></i></div>
                        <div style="flex:1"></div>
                        <div class="icon" title="Bookmark" onclick="event.stopPropagation(); alert('Bookmark feature not implemented yet')"><i class="fa-regular fa-bookmark"></i></div>
                    </div>

                    <div id="news_likes_count_${n.id}" class="news-likes-count">${escapeHtml(String(likesCount || 0))} likes</div>

                    ${commentsPreviewHTML}

                    <div class="news-comment-input-row">
                        <img src="${userAvatarPreview}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;border:1px solid var(--glass-border);" onclick="openProfileModal()" title="Update profile" loading="lazy">
                        <input id="news_ctext_${n.id}" class="news-comment-input" placeholder="${stored.name ? 'Comment as ' + escapeHtml(stored.name) : 'Set profile to comment'}">
                        <button class="news-post-btn" onclick="postNewsComment(${n.id}); event.stopPropagation();">Post</button>
                    </div>
                </div>
            </div>
        </div>`;
    });
    list.innerHTML = html;

    // After inserting HTML, update like button states (if liked by this user)
    items.forEach(n => {
        updateNewsStats(n.id);
    });
}
window.renderNews = renderNews;

/* Register a view for a news item when user opens the link.
   Only one view per account (local).
*/
async function registerNewsView(newsId) {
    try {
        const localKey = `MEGA_NEWS_VIEWED_${newsId}`;
        if (localStorage.getItem(localKey)) {
            updateNewsStats(newsId);
            return;
        }
        localStorage.setItem(localKey, '1');

        const idKey = getNewsKey(newsId);
        const userId = ensureUserId();
        if (!viewsDB[idKey]) viewsDB[idKey] = {};
        viewsDB[idKey][userId] = true;
        localStorage.setItem(VIEWS_KEY, JSON.stringify(viewsDB));
        updateNewsStats(newsId);
        renderNews();

        if (fbAvailable && rdb) {
            try {
                await set(rdbRef(rdb, `views/${idKey}/${userId}`), true);
            } catch (e) {
                console.warn("Failed to set news view in firebase:", e);
            }
        }
    } catch (e) {
        console.warn("registerNewsView error:", e);
    }
}
window.registerNewsView = registerNewsView;

/* Toggle like for news item */
async function toggleNewsLike(newsId, event) {
    event && event.stopPropagation && event.stopPropagation();
    try {
        const idKey = getNewsKey(newsId);
        const userId = ensureUserId();
        if (!likesDB[idKey]) likesDB[idKey] = {};
        const already = !!likesDB[idKey][userId];
        if (already) {
            delete likesDB[idKey][userId];
        } else {
            likesDB[idKey][userId] = true;
        }
        localStorage.setItem(LIKES_KEY, JSON.stringify(likesDB));
        updateNewsStats(newsId);
        renderNews();

        if (fbAvailable && rdb) {
            try {
                if (already) {
                    await set(rdbRef(rdb, `likes/${idKey}/${userId}`), null);
                } else {
                    await set(rdbRef(rdb, `likes/${idKey}/${userId}`), true);
                }
            } catch (e) {
                console.warn("Failed to sync news like to firebase:", e);
            }
        }
    } catch (e) {
        console.warn("toggleNewsLike error:", e);
    }
}
window.toggleNewsLike = toggleNewsLike;

/* Update news UI counts + like icon state
   Also updates the comments preview (first 3) and the "show more" button text/count.
*/
function updateNewsStats(newsId) {
    try {
        const idKey = getNewsKey(newsId);
        const likesCountEl = document.getElementById(`news_likes_count_${newsId}`);
        const likeIcon = document.getElementById(`news_like_icon_${newsId}`);
        const userId = ensureUserId();
        const likesFor = likesDB[idKey] || {};
        const viewsFor = viewsDB[idKey] || {};
        if (likesCountEl) likesCountEl.innerText = `${Object.keys(likesFor).length} likes`;
        if (likeIcon) {
            const liked = !!likesFor[userId];
            likeIcon.className = liked ? 'fa-solid fa-heart' : 'fa-regular fa-heart';
            likeIcon.style.color = liked ? '' : '';
        }
        // update comments preview area in case comments changed
        const commentsContainer = document.getElementById(`news_comments_${newsId}`);
        const allCommentsContainer = document.getElementById(`news_all_comments_${newsId}`);
        const showMoreBtn = document.getElementById(`news_show_more_btn_${newsId}`);
        const commsObj = commentsDB[idKey] || {};
        let commsArr = [];
        if (Array.isArray(commsObj)) {
            commsArr = commsObj;
        } else {
            commsArr = Object.keys(commsObj).map(k => ({ id: k, ...commsObj[k] }));
            commsArr.sort((a,b) => {
                const da = a.date ? new Date(a.date) : 0;
                const dbb = b.date ? new Date(b.date) : 0;
                return dbb - da;
            });
        }
        if (commentsContainer) {
            if (commsArr.length === 0) {
                commentsContainer.innerHTML = 'No comments yet';
                commentsContainer.classList.add('news-comments-placeholder');
            } else {
                commentsContainer.classList.remove('news-comments-placeholder');
                commentsContainer.innerHTML = commsArr.slice(0,3).map(c => {
                    const av = c.avatar || createLetterAvatar(c.name || 'Anonymous', 64);
                    return `
                    <div class="comment-item" style="background:transparent; border:none; padding:6px 0;">
                      <div class="comment-row">
                        <img src="${av}" class="comment-avatar" loading="lazy">
                        <div class="comment-body">
                          <div class="comment-user">${escapeHtml(c.name || 'Anonymous')}</div>
                          <div class="comment-text">${escapeHtml(c.comment || '')}</div>
                          <div class="comment-date">${ formatDate(c.date) }</div>
                        </div>
                      </div>
                    </div>
                `}).join('');
            }
        }
        // update show-more button and full comments container if present
        const moreCount = Math.max(0, commsArr.length - 3);
        if (showMoreBtn) {
            if (moreCount > 0) {
                showMoreBtn.style.display = 'inline-block';
                showMoreBtn.innerText = `Show ${moreCount} more comment${moreCount>1?'s':''}`;
            } else {
                showMoreBtn.style.display = 'none';
            }
        }
        if (allCommentsContainer) {
            // if it's open, refresh its contents
            if (allCommentsContainer.classList.contains('open')) {
                allCommentsContainer.innerHTML = commsArr.map(c => {
                    const av = c.avatar || createLetterAvatar(c.name || 'Anonymous', 64);
                    return `
                    <div class="comment-item" style="background:transparent; border:none; padding:6px 0;">
                      <div class="comment-row">
                        <img src="${av}" class="comment-avatar" loading="lazy">
                        <div class="comment-body">
                          <div class="comment-user">${escapeHtml(c.name || 'Anonymous')}</div>
                          <div class="comment-text">${escapeHtml(c.comment || '')}</div>
                          <div class="comment-date">${ formatDate(c.date) }</div>
                        </div>
                      </div>
                    </div>
                `}).join('');
            } else {
                // leave empty / hidden when closed
                allCommentsContainer.innerHTML = '';
            }
        }
    } catch (e) {
        console.warn("updateNewsStats error:", e);
    }
}
window.updateNewsStats = updateNewsStats;

/* Toggle show/hide all comments for a news item */
function toggleNewsComments(newsId) {
    try {
        const idKey = getNewsKey(newsId);
        const allCommentsContainer = document.getElementById(`news_all_comments_${newsId}`);
        const showMoreBtn = document.getElementById(`news_show_more_btn_${newsId}`);
        if (!allCommentsContainer) return;
        const commsObj = commentsDB[idKey] || {};
        let commsArr = [];
        if (Array.isArray(commsObj)) {
            commsArr = commsObj;
        } else {
            commsArr = Object.keys(commsObj).map(k => ({ id: k, ...commsObj[k] }));
            commsArr.sort((a,b) => {
                const da = a.date ? new Date(a.date) : 0;
                const dbb = b.date ? new Date(b.date) : 0;
                return dbb - da;
            });
        }
        const isOpen = allCommentsContainer.classList.toggle('open');
        if (isOpen) {
            // render all comments
            allCommentsContainer.innerHTML = commsArr.map(c => {
                const av = c.avatar || createLetterAvatar(c.name || 'Anonymous', 64);
                return `
                <div class="comment-item" style="background:transparent; border:none; padding:6px 0;">
                  <div class="comment-row">
                    <img src="${av}" class="comment-avatar" loading="lazy">
                    <div class="comment-body">
                      <div class="comment-user">${escapeHtml(c.name || 'Anonymous')}</div>
                      <div class="comment-text">${escapeHtml(c.comment || '')}</div>
                      <div class="comment-date">${ formatDate(c.date) }</div>
                    </div>
                  </div>
                </div>
            `}).join('');
            if (showMoreBtn) showMoreBtn.innerText = `Hide comments`;
        } else {
            // close
            allCommentsContainer.innerHTML = '';
            // reset show more text showing how many more exist
            const moreCount = Math.max(0, commsArr.length - 3);
            if (showMoreBtn) {
                if (moreCount > 0) showMoreBtn.innerText = `Show ${moreCount} more comment${moreCount>1?'s':''}`;
                else showMoreBtn.style.display = 'none';
            }
        }
    } catch (e) {
        console.warn("toggleNewsComments error:", e);
    }
}
window.toggleNewsComments = toggleNewsComments;

/* Post comment for a news item */
async function postNewsComment(newsId) {
    try {
        const textEl = document.getElementById(`news_ctext_${newsId}`);
        const comment = textEl ? textEl.value.trim() : '';
        const profile = getStoredProfile();
        const name = (profile.name || '').trim();

        if (!name) {
            alert("Please set your profile name first.");
            openProfileModal();
            return;
        }
        if (!comment) {
            alert("Please enter a comment.");
            return;
        }
        localStorage.setItem(USER_NAME_KEY, name);
        const newComment = { name, comment, date: new Date().toISOString(), avatar: (profile.useAccountPic ? profile.avatar : '') || '' };
        const idKey = getNewsKey(newsId);

        // Ensure structure exists locally
        if (!commentsDB[idKey] || typeof commentsDB[idKey] !== 'object') commentsDB[idKey] = {};

        // Local id used until firebase generates key
        const localId = 'l_' + Date.now();

        // Add locally first so UI updates immediately
        commentsDB[idKey][localId] = newComment;
        localStorage.setItem(COMMENT_KEY, JSON.stringify(commentsDB));
        if (textEl) textEl.value = '';
        updateNewsStats(newsId);
        renderNews();

        // Try Firebase write: prefer deterministic key (userId + timestamp) so we can update local cache consistently.
        const userId = ensureUserId();
        const realKey = `${userId}_${Date.now()}`;

        // If firebase SDK available, try set -> push fallback
        if (fbAvailable && typeof rdb !== 'undefined' && rdb) {
            try {
                await set(rdbRef(rdb, `comments/${idKey}/${realKey}`), newComment);
                // replace local temporary id with realKey
                commentsDB[idKey][realKey] = newComment;
                delete commentsDB[idKey][localId];
                localStorage.setItem(COMMENT_KEY, JSON.stringify(commentsDB));
                updateNewsStats(newsId);
                renderNews();
                return;
            } catch (e) {
                console.warn('Firebase set failed for news comment, trying push fallback', e);
                try {
                    const pushedRef = await push(rdbRef(rdb, `comments/${idKey}`), newComment);
                    if (pushedRef && pushedRef.key) {
                        commentsDB[idKey][pushedRef.key] = newComment;
                        delete commentsDB[idKey][localId];
                        localStorage.setItem(COMMENT_KEY, JSON.stringify(commentsDB));
                        updateNewsStats(newsId);
                        renderNews();
                        return;
                    }
                } catch (e2) {
                    console.warn('Firebase push fallback failed for news comment', e2);
                    // continue to REST fallback
                }
            }
        }

        // REST fallback (try PUT to deterministic key, then POST)
        try {
            // Try deterministic PUT to comments/{idKey}/{realKey}
            await writeToRealtimeDBRest(`comments/${idKey}/${realKey}`, newComment, 'PUT');
            commentsDB[idKey][realKey] = newComment;
            delete commentsDB[idKey][localId];
            localStorage.setItem(COMMENT_KEY, JSON.stringify(commentsDB));
            updateNewsStats(newsId);
            renderNews();
            return;
        } catch (e) {
            console.warn('REST PUT fallback failed for news comment', e);
            try {
                // Try POST to comments/{idKey}.json to get a generated key
                const resp = await writeToRealtimeDBRest(`comments/${idKey}`, newComment, 'POST');
                // REST POST returns { name: "<generated_key>" } in Realtime DB
                const generatedKey = resp && resp.name ? resp.name : null;
                if (generatedKey) {
                    commentsDB[idKey][generatedKey] = newComment;
                    delete commentsDB[idKey][localId];
                    localStorage.setItem(COMMENT_KEY, JSON.stringify(commentsDB));
                    updateNewsStats(newsId);
                    renderNews();
                    return;
                }
            } catch (e2) {
                console.warn('REST POST fallback failed for news comment', e2);
            }
        }

        // If we get here, all remote writes failed â€” keep local comment and inform user
        alert('Comment saved locally. It will be shared publicly once network/database is available.');
    } catch (err) {
        console.error('postNewsComment unexpected error:', err);
        alert('Could not post comment. Saved locally; will sync when possible. Check console for details.');
    }
}
window.postNewsComment = postNewsComment;

/* Share news link */
async function shareNews(id) {
    const n = newsDB.find(x => Number(x.id) === Number(id));
    if (!n) return alert("News not found");
    const shareUrl = n.link || `${location.origin}${location.pathname}#news=${id}`;
    const shareTitle = n.title || 'News';
    const shareText = n.desc ? n.desc.slice(0, 140) : n.title;
    if (navigator.share) {
        try {
            await navigator.share({ title: shareTitle, text: shareText, url: shareUrl });
            return;
        } catch (e) {}
    }
    if (navigator.clipboard && navigator.clipboard.writeText) {
        try {
            await navigator.clipboard.writeText(shareUrl);
            alert("Link copied to clipboard! Share it with others.");
            return;
        } catch (e) {}
    }
    prompt("Copy and share this link:", shareUrl);
}
window.shareNews = shareNews;

/* openDetail: shows project + comments (read-only view) and registers a single view per account */
function openDetail(id, skipPush) {
    const p = db.find(x => Number(x.id) === Number(id));
    if (!p) return alert("Project not found");
    currentDetailId = id;

    const commsObj = commentsDB[id] || {};
    let commsArr = [];
    if (Array.isArray(commsObj)) {
        commsArr = commsObj;
    } else {
        commsArr = Object.keys(commsObj).map(k => ({ id: k, ...commsObj[k] }));
        commsArr.sort((a,b) => {
            const da = a.date ? new Date(a.date) : 0;
            const dbb = b.date ? new Date(b.date) : 0;
            return dbb - da;
        });
    }

    const saved = getStoredProfile();

    try {
        const newUrl = `${location.pathname}?app=${id}`;
        if (!skipPush) {
            history.pushState({p:1}, '', newUrl);
        } else {
            history.replaceState({p:1}, '', newUrl);
        }
    } catch (e) {}

    document.getElementById('detailContent').innerHTML = `
        <i class="fa-solid fa-arrow-left" onclick="history.back()" style="font-size:24px; cursor:pointer; margin-bottom:15px;"></i>
        <div style="display:flex; gap:15px; margin-bottom:20px; align-items:center;">
            <div class="icon-box loading" style="width:72px;height:72px;border-radius:18px;overflow:hidden;"><img src="${p.icon}" loading="lazy" decoding="async" onload="onIconLoad(this)" onerror="onIconError(this)" style="width:72px;height:72px;border-radius:18px;"></div>
            <div><h3>${escapeHtml(p.name)}</h3><p style="color:var(--primary); font-size:13px;">${escapeHtml(p.dev || '')}</p></div>
        </div>
        <button class="btn-download" onclick="window.open('${p.dLink}')">Download</button>
        <div style="margin-top:8px;">
            <button class="share-btn share-primary" onclick="shareApp(${id})">
                <i class="fa-solid fa-share-nodes"></i> Share
            </button>
            <button id="commentBtn" class="share-btn" style="margin-left:10px;" onclick="focusComment(${id}, event)">
                <i class="fa-regular fa-comment"></i> Comment
            </button>
            <button id="likeBtn" class="like-btn" style="margin-left:10px;" onclick="toggleLike(${id}, event)">
                Loading...
            </button>
        </div>
        <div id="statBoxHolder" class="stat-box">
            <div><b>${escapeHtml(String(p.rating || ''))} â˜…</b><br><small>Rating</small></div>
            <div><b id="commentCount">${commsArr.length}</b><br><small>Comments</small></div>
            <div><b id="viewsCount">0</b><br><small>Views</small></div>
            <div><b id="likesCount">0</b><br><small>Likes</small></div>
        </div>
        <h4 style="margin:15px 0 10px;">Screenshots</h4>
        <div style="display:flex; gap:10px; overflow-x:auto; scrollbar-width:none;">
            ${(p.ss || []).map(s=>`<img src="${s}" class="ss-img loading" loading="lazy" decoding="async" onclick="zoomImage('${s}')" onload="onSSLoad(this)" onerror="onSSLoadError(this)">`).join('')}
        </div>
        <h4 style="margin:20px 0 10px;">About</h4>
        <div class="desc" style="color:gray; font-size:14px; line-height:1.5;">${linkify(p.desc || '')}</div>

        <div class="comment-section">
            <h4>Comments</h4>
            <div style="display:flex; gap:10px; align-items:center; margin-bottom:8px;">
              <img src="${(saved.useAccountPic && saved.avatar) ? saved.avatar : createLetterAvatar(saved.name || 'U', 72)}" style="width:44px;height:44px;border-radius:50%;object-fit:cover;border:1px solid var(--glass-border);" onclick="openProfileModal()" title="Update profile" loading="lazy">
              <div style="font-weight:800">${escapeHtml(saved.name || 'Anonymous')}</div>
            </div>
            <textarea id="cText" placeholder="Write a comment..." rows="2"></textarea>
            <button class="btn-download" style="margin:10px 0;" onclick="postComment(${id})">Post Comment</button>
            <div id="commentList">
                ${commsArr.map(c => {
                    const av = c.avatar || createLetterAvatar(c.name || 'Anonymous', 64);
                    return `
                    <div class="comment-item">
                        <div class="comment-row">
                          <img src="${av}" class="comment-avatar" loading="lazy">
                          <div class="comment-body">
                            <div class="comment-user">${escapeHtml(c.name || 'Anonymous')}</div>
                            <div class="comment-text">${escapeHtml(c.comment || '')}</div>
                            <div class="comment-date">${ formatDate(c.date) }</div>
                          </div>
                        </div>
                    </div>
                    `;
                }).join('')}
            </div>
        </div>
    `;
    document.getElementById('detailPage').style.display = 'block';

    // Register a view for this account (only one view per account/device)
    registerView(id);

    // Update likes/views UI counts and like button state
    updateDetailStats(id);

    // ensure comment button shows updated comment count (in case comments changed)
    const commentCountEl = document.getElementById('commentCount');
    if (commentCountEl) commentCountEl.innerText = commsArr.length;
}
window.openDetail = openDetail;

/* Register a view for an app for the current user. Only first view from this account increments. */
async function registerView(appId) {
    try {
        const localKey = `MEGA_VIEWED_${appId}`;
        if (localStorage.getItem(localKey)) {
            updateDetailStats(appId);
            return;
        }
        localStorage.setItem(localKey, '1');

        const userId = ensureUserId();
        if (!viewsDB[appId]) viewsDB[appId] = {};
        viewsDB[appId][userId] = true;
        localStorage.setItem(VIEWS_KEY, JSON.stringify(viewsDB));
        updateDetailStats(appId);
        render(); // update grid counts

        // update firebase (set a presence entry under /views/{appId}/{userId} = true)
        if (fbAvailable && rdb) {
            try {
                await set(rdbRef(rdb, `views/${appId}/${userId}`), true);
            } catch (e) {
                console.warn("Failed to set view in firebase:", e);
            }
        }
    } catch (e) {
        console.warn("registerView error:", e);
    }
}
window.registerView = registerView;

/* Toggle like for current user on an app.
   Enforces one like per account (userId key). If user already liked, this implementation allows unliking (toggle).
*/
async function toggleLike(appId, event) {
    event && event.stopPropagation && event.stopPropagation();
    const userId = ensureUserId();
    if (!likesDB[appId]) likesDB[appId] = {};
    const already = !!likesDB[appId][userId];
    if (already) {
        // Unlike (toggle).
        delete likesDB[appId][userId];
    } else {
        likesDB[appId][userId] = true;
    }
    localStorage.setItem(LIKES_KEY, JSON.stringify(likesDB));
    updateDetailStats(appId);
    render(); // update grid counts

    // sync to firebase under /likes/{appId}/{userId} = true/removed
    if (fbAvailable && rdb) {
        try {
            if (already) {
                // remove like
                await set(rdbRef(rdb, `likes/${appId}/${userId}`), null);
            } else {
                await set(rdbRef(rdb, `likes/${appId}/${userId}`), true);
            }
        } catch (e) {
            console.warn("Failed to sync like to firebase:", e);
        }
    }
}
window.toggleLike = toggleLike;

/* Update counts and like button appearance inside detail view */
function updateDetailStats(appId) {
    try {
        const likesCountEl = document.getElementById('likesCount');
        const viewsCountEl = document.getElementById('viewsCount');
        const likeBtn = document.getElementById('likeBtn');
        const userId = ensureUserId();

        const likesForApp = likesDB[appId] || {};
        const viewsForApp = viewsDB[appId] || {};

        const likesCount = Object.keys(likesForApp).length;
        const viewsCount = Object.keys(viewsForApp).length;

        if (likesCountEl) likesCountEl.innerText = likesCount;
        if (viewsCountEl) viewsCountEl.innerText = viewsCount;

        if (likeBtn) {
            const liked = !!likesForApp[userId];
            if (liked) {
                likeBtn.className = 'like-active';
                likeBtn.innerHTML = `<i class="fa-solid fa-heart"></i> Liked`;
            } else {
                likeBtn.className = 'share-btn';
                likeBtn.innerHTML = `<i class="fa-regular fa-heart"></i> Like`;
            }
        }

        // update comment count (if detail open)
        const commsObj = commentsDB[appId] || {};
        const commentCount = Array.isArray(commsObj) ? commsObj.length : Object.keys(commsObj || {}).length;
        const commentCountEl = document.getElementById('commentCount');
        if (commentCountEl) commentCountEl.innerText = commentCount;

    } catch (e) {
        console.warn("updateDetailStats error:", e);
    }
}

/* Focus comment (unchanged) */
function focusComment(appId, event) {
    event && event.stopPropagation && event.stopPropagation();
    if (!currentDetailId || Number(currentDetailId) !== Number(appId)) {
        openDetail(appId);
        setTimeout(() => {
            const t = document.getElementById('cText');
            if (t) t.focus();
        }, 300);
    } else {
        const t = document.getElementById('cText');
        if (t) t.focus();
    }
}
window.focusComment = focusComment;

/* Share function (unchanged) */
async function shareApp(id) {
    const p = db.find(x => Number(x.id) === Number(id));
    if (!p) return alert("Project not found");
    const shareUrl = `${location.origin}${location.pathname}?app=${id}`;
    const shareTitle = p.name || 'Mega store';
    const shareText = p.desc ? p.desc.slice(0, 140) : `Check out ${p.name} on Mega store`;

    if (navigator.share) {
        try {
            await navigator.share({ title: shareTitle, text: shareText, url: shareUrl });
            return;
        } catch (e) {}
    }
    if (navigator.clipboard && navigator.clipboard.writeText) {
        try {
            await navigator.clipboard.writeText(shareUrl);
            alert("Link copied to clipboard! Share it with others.");
            return;
        } catch (e) {}
    }
    prompt("Copy and share this link:", shareUrl);
}
window.shareApp = shareApp;

function formatDate(d) {
    if (!d) return '';
    try {
        const dt = new Date(d);
        if (isNaN(dt)) return d;
        return dt.toLocaleString();
    } catch (e) {
        return d;
    }
}

/* Image zoom */
function zoomImage(src) {
    const zm = document.getElementById('zoomImg');
    if (zm) zm.src = src;
    const overlay = document.getElementById('zoomOverlay');
    if (overlay) overlay.style.display = 'flex';
    history.pushState({zoom:1}, '');
}
window.zoomImage = zoomImage;

/* Post comment (modified - for apps)
   FIX: Use deterministic key for Firebase writes similar to news comments.
   Improved: multiple remote fallback attempts (set -> push -> REST). Always keep local comment so UI updates instantly.
*/
async function postComment(appId) {
    try {
        const textEl = document.getElementById('cText');
        const commentInput = textEl ? textEl.value.trim() : '';
        const profile = getStoredProfile();
        const nameInput = (profile.name || '').trim();

        if (!nameInput) {
            alert("Please set your profile name first.");
            openProfileModal();
            return;
        }
        if (!commentInput) {
            alert("Please enter a comment.");
            return;
        }
        localStorage.setItem(USER_NAME_KEY, nameInput);

        const newComment = { name: nameInput, comment: commentInput, date: new Date().toISOString(), avatar: (profile.useAccountPic ? profile.avatar : '') || '' };

        // Local fallback + immediate UI update
        if (!commentsDB[appId] || typeof commentsDB[appId] !== 'object') commentsDB[appId] = {};
        const localCid = 'l_' + Date.now();
        commentsDB[appId][localCid] = newComment;
        localStorage.setItem(COMMENT_KEY, JSON.stringify(commentsDB));

        if (textEl) textEl.value = '';
        // Re-open detail to refresh comment list (or manually update commentList)
        openDetail(appId, true);

        // Prepare deterministic real key
        const userId = ensureUserId();
        const realKey = `${userId}_${Date.now()}`;

        // 1) If Firebase SDK available, try deterministic set() then push() fallback
        if (fbAvailable && typeof rdb !== 'undefined' && rdb) {
            try {
                await set(rdbRef(rdb, `comments/${appId}/${realKey}`), newComment);
                // move local comment to real key
                commentsDB[appId][realKey] = newComment;
                delete commentsDB[appId][localCid];
                localStorage.setItem(COMMENT_KEY, JSON.stringify(commentsDB));
                openDetail(appId, true);
                return;
            } catch (e) {
                console.warn('Firebase set failed for app comment, trying push fallback', e);
                try {
                    const pushedRef = await push(rdbRef(rdb, `comments/${appId}`), newComment);
                    if (pushedRef && pushedRef.key) {
                        commentsDB[appId][pushedRef.key] = newComment;
                        delete commentsDB[appId][localCid];
                        localStorage.setItem(COMMENT_KEY, JSON.stringify(commentsDB));
                        openDetail(appId, true);
                        return;
                    }
                } catch (e2) {
                    console.warn('Firebase push fallback failed for app comment', e2);
                    // continue to REST fallback
                }
            }
        }

        // 2) REST fallback (deterministic PUT to comments/{appId}/{realKey}, then POST)
        try {
            await writeToRealtimeDBRest(`comments/${appId}/${realKey}`, newComment, 'PUT');
            commentsDB[appId][realKey] = newComment;
            delete commentsDB[appId][localCid];
            localStorage.setItem(COMMENT_KEY, JSON.stringify(commentsDB));
            openDetail(appId, true);
            return;
        } catch (e) {
            console.warn('REST PUT fallback failed for app comment', e);
            try {
                const resp = await writeToRealtimeDBRest(`comments/${appId}`, newComment, 'POST');
                const generatedKey = resp && resp.name ? resp.name : null;
                if (generatedKey) {
                    commentsDB[appId][generatedKey] = newComment;
                    delete commentsDB[appId][localCid];
                    localStorage.setItem(COMMENT_KEY, JSON.stringify(commentsDB));
                    openDetail(appId, true);
                    return;
                }
            } catch (e2) {
                console.warn('REST POST fallback failed for app comment', e2);
            }
        }

        // 3) If we reach here, all remote writes failed. Keep local comment and notify user.
        alert('Comment saved locally. It will be shared publicly once network/database is available.');
    } catch (err) {
        console.error('postComment unexpected error:', err);
        alert('Could not post comment. Saved locally; will sync when possible. Check console for details.');
    }
}
window.postComment = postComment;

/* Upload modal controls and submission
   NOTE: Upload modal removed from DOM and bottom nav; functions remain in case needed via other UI triggers.
*/
function openUploadModal() {
    const m = document.getElementById('uploadModal');
    if (m) m.style.display = 'flex';
}
window.openUploadModal = openUploadModal;

function closeUploadModal() {
    const m = document.getElementById('uploadModal');
    if (m) m.style.display = 'none';
}
window.closeUploadModal = closeUploadModal;

/* ------------------ Search + navigation + tab (modified for Play-Store-like list results) ------------------ */
/* doSearch now renders a vertical list styled like Play Store results (icon left, title + meta middle, chevron right) */
/* NOTE: results are limited to 4 items line-by-line per user request */
function doSearch() {
    const qRaw = (document.getElementById('searchInput') ? document.getElementById('searchInput').value : '') || '';
    const q = qRaw.trim().toLowerCase();
    const homeV = document.getElementById('home-view'), allV = document.getElementById('all-view'), searchV = document.getElementById('search-view'), res = document.getElementById('searchResults'), newsV = document.getElementById('news-view');

    if (q.length > 0) {
        // If user is on news and typed, search news first
        if (currentTab === 'news' || (newsV && newsV.style.display === 'block')) {
            const filtered = (newsDB || []).filter(n => {
                const t = (n.title || '').toLowerCase();
                const d = (n.desc || '').toLowerCase();
                return t.includes(q) || d.includes(q);
            }).slice(0,4); // limit to 4
            renderNews(filtered);
            newsV.style.display = 'block';
            homeV.style.display = 'none';
            allV.style.display = 'none';
            searchV.style.display = 'none';
            return;
        }

        if (newsV) newsV.style.display = 'none';
        homeV.style.display = 'none'; allV.style.display = 'none'; searchV.style.display = 'block';

        // Build Play-Store-like list
        const matches = db.filter(p => {
            const name = (p.name || '').toLowerCase();
            const dev  = (p.dev || '').toLowerCase();
            const cat  = (p.cat || '').toLowerCase();
            return name.includes(q) || dev.includes(q) || cat.includes(q);
        }).slice(0,4); // show only up to 4 results as requested

        if (!matches || matches.length === 0) {
            res.innerHTML = "<p style='color:gray; text-align:center; padding:16px;'>No Results</p>";
            return;
        }

        // Build HTML for each match
        const html = matches.map(p => {
            const id = p.id;
            const icon = p.icon || 'https://via.placeholder.com/150';
            const title = escapeHtml(p.name || 'Untitled');
            const dev = escapeHtml(p.dev || '');
            // categories: if p.tags or p.cat exists, use that; else fallback to empty
            const cats = escapeHtml((p.cat && p.cat !== 'undefined') ? p.cat : (Array.isArray(p.tags) ? p.tags.join(' â€¢ ') : ''));
            // rating, size, downloads - use available fields otherwise show placeholders
            const rating = (typeof p.rating !== 'undefined' && p.rating !== null) ? String(p.rating) : (p.r ? String(p.r) : 'â€”');
            const size = p.size || p.appSize || 'â€”';
            const downloads = p.downloads || p.installs || p.dl || '100k+';
            // likes/views fallback counts in case stored under likes/views map by id
            const likesCount = countFor(likesDB, id);
            const viewsCount = countFor(viewsDB, id);

            return `
                <div class="search-item" onclick="openDetail(${id})" title="${title}">
                    <div class="result-icon">
                        <img src="${icon}" alt="${title}" loading="lazy" onerror="this.src='https://via.placeholder.com/150'">
                    </div>
                    <div class="result-meta">
                        <div class="result-title">${title}</div>
                        <div class="result-sub">
                            <div>${dev}${cats ? ' â€¢ ' + cats : ''}</div>
                        </div>
                        <div class="meta-small">
                            <div class="pill" title="Rating"><i class="fa-solid fa-star" style="font-size:12px;color:var(--star);"></i> ${escapeHtml(String(rating))}</div>
                            <div style="color:#6b7280;">${escapeHtml(String(size))}</div>
                            <div style="display:flex; align-items:center; gap:6px; color:#6b7280;"><i class="fa-solid fa-download" style="color:#3b82f6;"></i> ${escapeHtml(String(downloads))}</div>
                            <div style="margin-left:8px; color:#6b7280;">${escapeHtml(String(viewsCount))} views</div>
                            <div style="color:#6b7280;">${escapeHtml(String(likesCount))} likes</div>
                        </div>
                    </div>
                    <div class="chev-btn" onclick="event.stopPropagation(); toggleSearchExpand(${id}, this);">
                        <i class="fa-solid fa-angle-down"></i>
                    </div>
                </div>
            `;
        }).join('');

        res.innerHTML = html;
    } else {
        // if query cleared, keep search view visible but empty results, or fallback to previous tab behavior
        // We'll hide search view and header search when switching back to previous tab via tab() logic.
        document.getElementById('search-view').style.display = 'none';
        // Hide header search if not on search tab
        const headerSearch = document.getElementById('headerSearchContainer');
        if (currentTab !== 'search' && headerSearch) headerSearch.style.display = 'none';

        if (currentTab === 'news') {
            tab('news', document.getElementById('nav-news'));
        } else {
            tab(currentTab, document.querySelector(`.nav-item[onclick*='${currentTab}']`));
        }
    }
}
window.doSearch = doSearch;

/* Toggle expand/collapse for a search result to show screenshots only (Play Store style).
   - id: app id
   - btn: the chevron button element (this)
   This function inserts/removes an element with id='search_expand_<id>' right after the related .search-item.
   ONLY screenshots are shown â€” no download, no description, nothing else (per user request).
*/
function toggleSearchExpand(id, btn) {
    try {
        // Close other expands first
        document.querySelectorAll('.search-expand').forEach(e => e.remove());
        document.querySelectorAll('.chev-btn.open').forEach(b => b.classList.remove('open'));

        const resultsEl = document.getElementById('searchResults');
        if (!resultsEl) return;

        const itemBtn = btn;
        const item = itemBtn && itemBtn.closest('.search-item');
        if (!item) return;

        // If already open for this id, just close
        const existing = document.getElementById(`search_expand_${id}`);
        if (existing) {
            existing.remove();
            itemBtn.classList.remove('open');
            return;
        }

        // find app object (db is in module scope)
        const app = db.find(x => Number(x.id) === Number(id));
        if (!app) {
            // fallback: create a small placeholder showing no screenshots
            const errHtml = `<div id="search_expand_${id}" class="search-expand"><div class="ss-row"><img src="https://via.placeholder.com/600x400" alt="no-ss"></div></div>`;
            item.insertAdjacentHTML('afterend', errHtml);
            itemBtn.classList.add('open');
            return;
        }

        // Build screenshots row ONLY
        let ssHtml = '';
        if (Array.isArray(app.ss) && app.ss.length > 0) {
            ssHtml += `<div class="ss-row">`;
            app.ss.forEach((s, idx) => {
                const safeSrc = s || 'https://via.placeholder.com/600x400';
                // clicking screenshot zooms it (same behavior as detail page)
                ssHtml += `<img src="${safeSrc}" alt="ss${idx}" loading="lazy" onclick="zoomImage('${safeSrc}')" onerror="this.src='https://via.placeholder.com/600x400'">`;
            });
            ssHtml += `</div>`;
        } else {
            // if no screenshots, show a single placeholder image (consistent minimal UI)
            ssHtml = `<div class="ss-row"><img src="https://via.placeholder.com/600x400" alt="no-ss" loading="lazy"></div>`;
        }

        // IMPORTANT: Only screenshots in expand â€” nothing else
        const expandHtml = `
            <div id="search_expand_${id}" class="search-expand" onclick="event.stopPropagation();">
                ${ssHtml}
            </div>
        `;

        item.insertAdjacentHTML('afterend', expandHtml);
        itemBtn.classList.add('open');

        // scroll into view so expanded content is visible on small screens
        const expandEl = document.getElementById(`search_expand_${id}`);
        if (expandEl) {
            setTimeout(() => {
                expandEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 80);
        }
    } catch (e) {
        console.warn('toggleSearchExpand error', e);
    }
}
window.toggleSearchExpand = toggleSearchExpand;

/* New: showSearchSamples
   When the user taps the bottom nav Search button, show Play-Store-like list with 4 apps (line-by-line) as requested.
   Each app is rendered line-by-line like doSearch results. This does not require typing â€” it shows sample results.
   Also shows the top header search container (search bar + profile) as requested.
   Drawer button removed per user request.
*/
function showSearchSamples(el) {
    // set active nav state
    currentTab = 'search';
    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
    if (el) el.classList.add('active');

    const homeV = document.getElementById('home-view'), allV = document.getElementById('all-view'), searchV = document.getElementById('search-view'), newsV = document.getElementById('news-view');
    homeV.style.display = 'none';
    allV.style.display = 'none';
    newsV.style.display = 'none';
    searchV.style.display = 'block';

    // Show header search container and keep profile visible
    const headerSearch = document.getElementById('headerSearchContainer');
    if (headerSearch) headerSearch.style.display = 'flex';

    const res = document.getElementById('searchResults');
    if (!res) return;

    // choose first 4 apps (deterministic). Keep only 4 as per user's requirement.
    const samples = (db && db.length) ? db.slice(0, Math.min(4, db.length)) : [];

    if (samples.length === 0) {
        res.innerHTML = "<p style='color:gray; text-align:center; padding:16px;'>No apps to show</p>";
        return;
    }

    const html = samples.map(p => {
        const id = p.id;
        const icon = p.icon || 'https://via.placeholder.com/150';
        const title = escapeHtml(p.name || 'Untitled');
        const dev = escapeHtml(p.dev || '');
        const cats = escapeHtml((p.cat && p.cat !== 'undefined') ? p.cat : (Array.isArray(p.tags) ? p.tags.join(' â€¢ ') : ''));
        const rating = (typeof p.rating !== 'undefined' && p.rating !== null) ? String(p.rating) : (p.r ? String(p.r) : 'â€”');
        const size = p.size || p.appSize || 'â€”';
        const downloads = p.downloads || p.installs || p.dl || '100k+';
        const likesCount = countFor(likesDB, id);
        const viewsCount = countFor(viewsDB, id);

        return `
            <div class="search-item" onclick="openDetail(${id})" title="${title}">
                <div class="result-icon">
                    <img src="${icon}" alt="${title}" loading="lazy" onerror="this.src='https://via.placeholder.com/150'">
                </div>
                <div class="result-meta">
                    <div class="result-title">${title}</div>
                    <div class="result-sub">
                        <div>${dev}${cats ? ' â€¢ ' + cats : ''}</div>
                    </div>
                    <div class="meta-small">
                        <div class="pill" title="Rating"><i class="fa-solid fa-star" style="font-size:12px;color:var(--star);"></i> ${escapeHtml(String(rating))}</div>
                        <div style="color:#6b7280;">${escapeHtml(String(size))}</div>
                        <div style="display:flex; align-items:center; gap:6px; color:#6b7280;"><i class="fa-solid fa-download" style="color:#3b82f6;"></i> ${escapeHtml(String(downloads))}</div>
                        <div style="margin-left:8px; color:#6b7280;">${escapeHtml(String(viewsCount))} views</div>
                        <div style="color:#6b7280;">${escapeHtml(String(likesCount))} likes</div>
                    </div>
                </div>
                <div class="chev-btn" onclick="event.stopPropagation(); toggleSearchExpand(${id}, this);">
                    <i class="fa-solid fa-angle-down"></i>
                </div>
            </div>
        `;
    }).join('');

    res.innerHTML = html;
}
window.showSearchSamples = showSearchSamples;

function tab(type, el) {
    currentTab = type;
    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
    if (el) el.classList.add('active');

    // Hide header search by default; show only for 'search' tab
    const headerSearch = document.getElementById('headerSearchContainer');
    if (headerSearch) {
        if (type === 'search') headerSearch.style.display = 'flex';
        else headerSearch.style.display = 'none';
    }

    document.getElementById('search-view').style.display = type === 'search' ? 'block' : 'none';
    document.getElementById('home-view').style.display = type === 'home' ? 'block' : 'none';
    document.getElementById('all-view').style.display = type === 'all' ? 'block' : 'none';
    document.getElementById('news-view').style.display = type === 'news' ? 'block' : 'none';
    if (type === 'news') {
        renderNews();
    }
}
window.tab = tab;

function goToAll() { tab('all', document.getElementById('nav-all')); }
window.goToAll = goToAll;

/* ------------------ Custom select implementation ------------------ */
/* Initialize custom select: attaches event listeners and sets initial state */
function initCustomSelect() {
  const wrapper = document.getElementById('u_cat_custom');
  const hidden = document.getElementById('u_cat');
  if (!wrapper || !hidden) return;

  const selected = wrapper.querySelector('.selected');
  const optionsEl = wrapper.querySelector('.options');
  const optionEls = Array.from(wrapper.querySelectorAll('.option'));

  // toggle open
  wrapper.addEventListener('click', (e) => {
    e.stopPropagation();
    const isOpen = wrapper.classList.toggle('open');
    wrapper.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
    optionsEl.setAttribute('aria-hidden', isOpen ? 'false' : 'true');
  });

  // choose option
  optionEls.forEach(opt => {
    opt.addEventListener('click', (ev) => {
      ev.stopPropagation();
      const v = opt.innerText.trim();
      selected.innerText = v;
      hidden.value = v;
      // mark active
      optionEls.forEach(o => o.classList.remove('active'));
      opt.classList.add('active');
      wrapper.classList.remove('open');
      wrapper.setAttribute('aria-expanded', 'false');
      optionsEl.setAttribute('aria-hidden', 'true');
    });
  });

  // keyboard support
  wrapper.addEventListener('keydown', (ev) => {
    if (ev.key === 'Enter' || ev.key === ' ') {
      ev.preventDefault();
      const isOpen = wrapper.classList.toggle('open');
      wrapper.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
      optionsEl.setAttribute('aria-hidden', isOpen ? 'false' : 'true');
    } else if (ev.key === 'Escape') {
      wrapper.classList.remove('open');
      wrapper.setAttribute('aria-expanded', 'false');
      optionsEl.setAttribute('aria-hidden', 'true');
    } else if (ev.key === 'ArrowDown' || ev.key === 'ArrowUp') {
      ev.preventDefault();
      let idx = optionEls.findIndex(o => o.classList.contains('active'));
      if (idx === -1) idx = 0;
      if (ev.key === 'ArrowDown') idx = Math.min(optionEls.length - 1, idx + 1);
      if (ev.key === 'ArrowUp') idx = Math.max(0, idx - 1);
      optionEls.forEach(o => o.classList.remove('active'));
      optionEls[idx].classList.add('active');
      optionEls[idx].scrollIntoView({ block: 'nearest' });
    }
  });

  // close when clicking outside
  document.addEventListener('click', () => {
    wrapper.classList.remove('open');
    wrapper.setAttribute('aria-expanded', 'false');
    optionsEl.setAttribute('aria-hidden', 'true');
  });

  // set default active based on hidden.value
  syncCustomSelectUI();
}

/* Sync custom select UI with hidden input value */
function syncCustomSelectUI() {
  const wrapper = document.getElementById('u_cat_custom');
  const hidden = document.getElementById('u_cat');
  if (!wrapper || !hidden) return;
  const selected = wrapper.querySelector('.selected');
  const optionEls = Array.from(wrapper.querySelectorAll('.option'));
  const current = (hidden.value || '').trim() || 'New';
  const match = optionEls.find(o => o.innerText.trim() === current);
  if (match) {
    optionEls.forEach(o => o.classList.remove('active'));
    match.classList.add('active');
    selected.innerText = current;
  } else {
    optionEls.forEach(o => o.classList.remove('active'));
    optionEls[0].classList.add('active');
    selected.innerText = optionEls[0].innerText.trim();
    hidden.value = optionEls[0].innerText.trim();
  }
}
/* ---------------- end custom select ------------------ */


/* ---------------- Profile modal handlers ---------------- */
function openProfileModal() {
    const m = document.getElementById('profileModal');
    if (m) m.style.display = 'flex';

    // push history state so phone back closes modal first
    try {
        history.pushState({modal:'profile'}, '');
    } catch (e) {}

    // populate fields
    const stored = getStoredProfile();
    const nameEl = document.getElementById('profile_name');
    const preview = document.getElementById('profilePreview');
    const usePicToggle = document.getElementById('profile_usepic_toggle');
    const display = document.getElementById('profileDisplayName');
    const sub = document.getElementById('profileSub');
    const linkInput = document.getElementById('profileLinkInput');

    if (nameEl) nameEl.value = stored.name || '';
    if (preview) preview.src = stored.avatar || createLetterAvatar(stored.name || 'User', 128);
    if (display) display.innerText = stored.name || 'Your Profile';
    if (sub) sub.innerText = 'Set your display name, profile image and appearance.';

    // sync use picture toggle
    setToggleElement(usePicToggle, !!stored.useAccountPic);

    // populate unique profile link
    if (linkInput) linkInput.value = generateProfileLink();
}
window.openProfileModal = openProfileModal;

function closeProfileModal() {
    const m = document.getElementById('profileModal');
    if (m) m.style.display = 'none';

    // if we have a history state for profile, go back so popstate will be consistent
    try {
        if (history.state && history.state.modal === 'profile') {
            ignoreNextPop = true;
            history.back();
        }
    } catch (e) {
        // ignore
    }
}
window.closeProfileModal = closeProfileModal;

/* helper to set toggle visuals */
function setToggleElement(el, state) {
    if (!el) return;
    if (state) {
        el.classList.add('on');
        el.setAttribute('aria-checked', 'true');
    } else {
        el.classList.remove('on');
        el.setAttribute('aria-checked', 'false');
    }
}

/* click handlers for toggles (visual + action) */
function toggleProfileUsePic(el) {
    const isOn = !el.classList.contains('on');
    setToggleElement(el, isOn);
    localStorage.setItem(USER_USE_PIC_KEY, isOn ? 'true' : 'false');
    refreshProfileUI();
}
window.toggleProfileUsePic = toggleProfileUsePic;

function removeProfilePhoto() {
    localStorage.removeItem(USER_AVATAR_KEY);
    const preview = document.getElementById('profilePreview');
    const stored = getStoredProfile();
    if (preview) preview.src = createLetterAvatar(stored.name || 'User', 128);
    refreshProfileUI();
    alert('Profile photo removed. Save to persist this change.');
}
window.removeProfilePhoto = removeProfilePhoto;

async function saveProfile() {
    try {
        const name = (document.getElementById('profile_name').value || '').trim();
        if (!name) return alert('Please enter a display name.');
        const fileInput = document.getElementById('profile_file');
        let avatarData = localStorage.getItem(USER_AVATAR_KEY) || '';

        if (fileInput && fileInput.files && fileInput.files[0]) {
            try {
                avatarData = await fileToDataURLWithProgressUser(fileInput.files[0], ()=>{});
            } catch (e) {
                console.warn('profile image conversion failed', e);
            }
        }

        // Dark mode removed: always keep light theme
        const usePicToggle = document.getElementById('profile_usepic_toggle');
        const usePic = usePicToggle && usePicToggle.classList.contains('on');

        localStorage.setItem(USER_NAME_KEY, name);
        // language omitted
        localStorage.setItem('MEGA_THEME', 'light'); // force light
        localStorage.setItem(USER_USE_PIC_KEY, usePic ? 'true' : 'false');

        if (avatarData) localStorage.setItem(USER_AVATAR_KEY, avatarData);

        // Update existing local comments: if commenter name matches saved name and avatar missing, add avatar
        try {
            const avatarToApply = avatarData || '';
            if (avatarToApply) {
                let changed = false;
                Object.keys(commentsDB).forEach(key => {
                    const group = commentsDB[key];
                    if (Array.isArray(group)) {
                        group.forEach(c => {
                            if (c && c.name === name && !c.avatar) { c.avatar = avatarToApply; changed = true; }
                        });
                    } else if (typeof group === 'object') {
                        Object.keys(group).forEach(cid => {
                            const c = group[cid];
                            if (c && c.name === name && !c.avatar) { c.avatar = avatarToApply; changed = true; }
                        });
                    }
                });
                if (changed) {
                    localStorage.setItem(COMMENT_KEY, JSON.stringify(commentsDB));
                }
            }
        } catch (e) {
            console.warn('Failed to update local comments with avatar', e);
        }

        // apply theme immediately (light only)
        setTheme('light');

        refreshProfileUI();
        closeProfileModal();
        alert('Profile & settings saved.');
        // re-render news & detail to reflect avatar/setting changes
        renderNews();
        if (currentDetailId) openDetail(currentDetailId, true);
    } catch (e) {
        console.error('saveProfile error', e);
        alert('Could not save profile. Check console.');
    }
}
window.saveProfile = saveProfile;

/* Initialize profile toggles on load (only use-pic toggle now) */
function initProfileToggles() {
    const stored = getStoredProfile();
    const usePicToggle = document.getElementById('profile_usepic_toggle');

    setToggleElement(usePicToggle, !!stored.useAccountPic);
}

/* Offline watch & UI toggling */
function setupOfflineWatcher() {
    function applyOffline(isOffline) {
        document.body.classList.toggle('offline', isOffline);
    }
    window.addEventListener('online', ()=> applyOffline(false));
    window.addEventListener('offline', ()=> applyOffline(true));
    // initial
    applyOffline(!navigator.onLine);
}

/* Expose internals for debugging */
window._MEGA_INTERNAL = {
    get db() { return db; },
    get commentsDB() { return commentsDB; },
    get newsDB() { return newsDB; },
    get likesDB() { return likesDB; },
    get viewsDB() { return viewsDB; },
    fbAvailable
} ;

/* ================= Additional helper functions for new features ================= */

/* Hide the Links and Profile Link blocks inside profile modal (do not delete code) */
function hideProfileLinksAndProfileLink() {
    try {
        // Provided links to hide (exact hrefs)
        const linkHrefs = [
            "https://www.youtube.com/@kapil_h4x_live",
            "https://www.instagram.com/kapil_das_2008?igsh=OHNlY3F1cGFxcHgx",
            "https://t.me/+f8mgewlTOpM2ZTVl",
            "https://t.me/+Nqu4kob-31o3YTU9"
        ];
        let anyHidden = false;
        linkHrefs.forEach(href => {
            const a = document.querySelector(`#profileModal a[href="${href}"]`);
            if (a) {
                // Hide the anchor itself
                a.style.display = 'none';
                anyHidden = true;
            }
        });
        // If links heading exists and all anchors hidden - hide the entire links container
        const linksContainer = document.querySelector('#profileModal .profile-links-block');
        if (linksContainer) {
            // hide the whole block
            linksContainer.style.display = 'none';
        }

        // Hide profile link block (input+copy) as requested
        const profileLinkInput = document.getElementById('profileLinkInput');
        if (profileLinkInput && profileLinkInput.parentElement) {
            // hide the entire parent block container
            const block = profileLinkInput.closest('.profile-link-block') || profileLinkInput.parentElement;
            if (block) block.style.display = 'none';
        }
        // Mark via class (CSS fallback)
        const profileLinkBlock = document.querySelector('#profileModal .profile-link-block');
        if (profileLinkBlock) profileLinkBlock.classList.add('links-hidden');

        // Also add a marker class for profile links container so CSS can hide it if JS fails
        const pl = document.querySelector('#profileModal .profile-links-block');
        if (pl) pl.classList.add('links-hidden');
    } catch (e) {
        console.warn('hideProfileLinksAndProfileLink error', e);
    }
}

/* End of added helpers */
</script>
</body>
</html>